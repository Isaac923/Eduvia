{% extends "base.html" %}
{% load static %}
    
{% block title %}Lista de Alumnos{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/alumnos/lista_alumnos.css' %}">
{% endblock %}

{% block content %}
<div class="user-list-container" data-permite-edicion="{{ permite_edicion|yesno:'true,false' }}">
    <!-- Encabezado de la p√°gina -->
    <div class="page-header">
        <div>
            <h2>Lista de Alumnos - A√±o {{ ano_actual.ano }}</h2>
            {% if not permite_edicion %}
                <div class="alert alert-warning mt-2 mb-0 d-flex justify-content-between align-items-center border-0 shadow-sm" style="background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%); color: white;">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <i class="fas fa-lock fa-2x"></i>
                        </div>
                        <div>
                            <h6 class="mb-1 fw-bold">
                                <i class="fas fa-eye me-2"></i>Modo Solo Lectura
                            </h6>
                            <p class="mb-0 small opacity-90">
                                Este a√±o acad√©mico {{ ano_actual.ano }} est√° bloqueado. Solo se pueden realizar modificaciones en el a√±o activo.
                            </p>
                        </div>
                    </div>
                    <button type="button" class="btn btn-light btn-sm ms-3 shadow-sm" onclick="activarAno({{ ano_actual.ano }})" style="color: #fd7e14; font-weight: bold;">
                        <i class="fas fa-unlock me-1"></i>Activar este a√±o
                    </button>
                </div>
            {% else %}
                <div class="alert alert-success mt-2 mb-0 border-0 shadow-sm" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white;">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <i class="fas fa-check-circle fa-2x"></i>
                        </div>
                        <div>
                            <h6 class="mb-1 fw-bold">
                                <i class="fas fa-unlock me-2"></i>A√±o Acad√©mico Activo
                            </h6>
                            <p class="mb-0 small opacity-90">
                                Este es el a√±o acad√©mico {{ ano_actual.ano }} activo. Puedes realizar todas las modificaciones necesarias.
                            </p>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
        <div class="header-actions">
            <!-- Selector de a√±o acad√©mico -->
            <select id="year-filter" class="form-select me-2" style="width: auto;" onchange="cambiarAno()">
                {% for ano in anos_disponibles %}
                    <option value="{{ ano.ano }}" {% if ano.ano == ano_actual.ano %}selected{% endif %}>
                        A√±o {{ ano.ano }}{% if ano.activo %} (Activo){% endif %}{% if ano.es_bloqueado %} üîí{% endif %}
                    </option>
                {% endfor %}
            </select>
            
            <!-- Bot√≥n para activar a√±o si no es el activo -->
            {% if not permite_edicion %}
                <button type="button" class="btn btn-warning" onclick="activarAno({{ ano_actual.ano }})">
                    Activar A√±o
                </button>
            {% endif %}
            
            <!-- Botones solo si permite edici√≥n -->
            {% if permite_edicion %}
                <button type="button" class="btn-eduvia btn-secondary me-2" onclick="crearNuevoAno()">
                    <i class="fas fa-calendar-plus"></i> Nuevo A√±o
                </button>
            
                <a href="{% url 'alumnos:crear_alumno' %}" class="btn-eduvia btn-primary">
                    <i class="fas fa-plus-circle"></i> Nuevo Alumno
                </a>
            {% else %}
                <span class="text-muted">
                    <i class="fas fa-lock me-1"></i>A√±o bloqueado
                </span>
            {% endif %}
        </div>
    </div>

    <!-- Mensajes -->
    {% if messages %}
        <div class="messages-container mb-4">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show auto-hide-alert" role="alert">
                    <i class="fas fa-info-circle me-2"></i>
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    {% if alumnos_ano %}
        <!-- B√∫squeda y filtros -->
        <div class="search-filter-container">
            <div class="filters-row">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" 
                           id="searchInput" 
                           class="form-control search-input" 
                           placeholder="üîç Buscar por nombre del alumno..."
                           value="{{ nombre_busqueda }}">
                </div>
                <div class="filter-group">
                    <select id="filterNivel" class="form-select filter-dropdown filter-nivel">
                        <option value="">üéì Todos los niveles</option>
                        {% for nivel in niveles %}
                            <option value="{{ nivel }}" {% if nivel_filter == nivel %}selected{% endif %}>
                                üìö {{ nivel }}
                            </option>
                        {% endfor %}
                    </select>
                    <select id="filterEstado" class="form-select filter-dropdown filter-estado">
                        <option value="">üìã Todos los estados</option>
                        <option value="activo" {% if estado_filter == 'activo' %}selected{% endif %}>‚úÖ Activo</option>
                        <option value="inactivo" {% if estado_filter == 'inactivo' %}selected{% endif %}>‚ùå Inactivo</option>
                    </select>
                    <!-- FILTRO DE DIAGN√ìSTICO ELIMINADO COMPLETAMENTE -->
                </div>
            </div>
        </div>
        
        <!-- Contenedor de tabla con scroll interno -->
        <div class="table-container">
            <table class="user-table">
                <thead>
                    <tr>
                        <th class="col-id"><i class="fas fa-hashtag me-2"></i>ID</th>
                        <th class="col-nombre"><i class="fas fa-user-graduate me-2"></i>Nombre</th>
                        <th class="col-edad"><i class="fas fa-birthday-cake me-2"></i>Edad</th>
                        <th class="col-nivel"><i class="fas fa-graduation-cap me-2"></i>Nivel</th>
                        <th class="col-jornada"><i class="fas fa-clock me-2"></i>Jornada</th>
                        <th class="col-estado"><i class="fas fa-toggle-on me-2"></i>Estado</th>
                        <th class="col-acciones"><i class="fas fa-cogs me-2"></i>Acciones</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    {% for alumno_ano in alumnos_ano %}
                    <tr class="alumno-row {% if not permite_edicion %}readonly-mode{% endif %}" 
                        data-id="{{ alumno_ano.alumno.id }}" 
                        data-nombre="{{ alumno_ano.alumno.nombre_completo|lower }}"
                        data-edad="{{ alumno_ano.alumno.edad }}" 
                        data-nivel="{{ alumno_ano.nivel }}"
                        data-jornada="{{ alumno_ano.jornada }}" 
                        data-direccion="{{ alumno_ano.alumno.direccion }}"
                        data-telefono="{{ alumno_ano.alumno.telefono|default:'No registrado' }}"
                        data-email="{{ alumno_ano.alumno.correo_electronico|default:'No registrado' }}"
                        data-religion="{{ alumno_ano.alumno.religion }}" 
                        data-fecha-ingreso="{{ alumno_ano.alumno.fecha_ingreso }}"
                        data-edit-url="{% url 'alumnos:editar_alumnos' pk=alumno_ano.alumno.id %}"
                        data-delete-url="{% url 'alumnos:eliminar_alumno' pk=alumno_ano.alumno.id %}"
                        data-fecha-nacimiento="{{ alumno_ano.alumno.fecha_nacimiento }}"
                        data-sexo="{{ alumno_ano.alumno.get_sexo_display }}"
                        data-rut="{{ alumno_ano.alumno.rut }}"
                        data-estado-civil="{{ alumno_ano.alumno.get_estado_civil_display }}"
                        data-ultimo-curso="{{ alumno_ano.alumno.ultimo_curso_aprobado|default:'No registrado' }}"
                        data-curso-repetido="{{ alumno_ano.alumno.curso_repetido }}"
                        data-programa-pie="{{ alumno_ano.alumno.programa_pie }}"
                        data-profesional-apoyo="{{ alumno_ano.alumno.get_profesional_apoyo_display|default:'Ninguno' }}"
                        data-informe-psicosocial="{{ alumno_ano.alumno.informe_psicosocial }}"
                        data-situacion-laboral="{{ alumno_ano.alumno.get_situacion_laboral_display }}"
                        data-contacto-emergencia-nombre="{{ alumno_ano.alumno.contacto_emergencia_nombre|default:'No registrado' }}"
                        data-contacto-emergencia-parentezco="{{ alumno_ano.alumno.contacto_emergencia_parentezco|default:'No registrado' }}"
                        data-contacto-emergencia-telefono="{{ alumno_ano.alumno.contacto_emergencia_telefono|default:'No registrado' }}"
                        data-apoderado-id="{{ alumno_ano.alumno.apoderado.id|default:'' }}"
                        data-apoderado-nombre="{{ alumno_ano.alumno.apoderado.nombre|default:'No registrado' }}"
                        data-apoderado-parentezco="{{ alumno_ano.alumno.apoderado.parentezco|default:'No registrado' }}"
                        data-apoderado-telefono="{{ alumno_ano.alumno.apoderado.telefono|default:'No registrado' }}"
                        data-apoderado-correo="{{ alumno_ano.alumno.apoderado.correo|default:'No registrado' }}"
                        data-apoderado-direccion="{{ alumno_ano.alumno.apoderado.direccion|default:'No registrado' }}"
                        data-apoderado-es-institucion="{{ alumno_ano.alumno.apoderado.es_institucion|default:'false' }}"
                        data-observaciones="{{ alumno_ano.alumno.observaciones|default:'Sin observaciones registradas' }}"
                        data-diagnostico="{{ alumno_ano.alumno.diagnostico|default:'No' }}"
                        data-estado="{% if alumno_ano.activo %}activo{% else %}inactivo{% endif %}">
                        <td class="col-id">{{ alumno_ano.alumno.id }}</td>
                        <td class="col-nombre">{{ alumno_ano.alumno.nombre_completo }}</td>
                        <td class="col-edad">{{ alumno_ano.alumno.edad }}</td>
                        <td class="col-nivel">{{ alumno_ano.nivel }}</td>
                        <td class="col-jornada">{{ alumno_ano.jornada }}</td>
                        <td>
                            {% if alumno_ano.activo %}
                                <span class="status-badge status-active">
                                    <i class="fas fa-check-circle"></i> Activo
                                </span>
                            {% else %}
                                <span class="status-badge status-inactive">
                                    <i class="fas fa-times-circle"></i> Inactivo
                                </span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-action btn-view ver-alumno-detallado" data-alumno-id="{{ alumno_ano.alumno.id }}">
                                    <i class="fas fa-eye"></i>
                                </button>
                                {% if permite_edicion %}
                                    <button class="btn-action btn-edit toggle-estado" 
                                            data-id="{{ alumno_ano.alumno.id }}"
                                            data-nombre="{{ alumno_ano.alumno.nombre_completo }}"
                                            data-estado="{% if alumno_ano.activo %}Activo{% else %}Inactivo{% endif %}"
                                            onclick="openEstadoModal(this)">
                                        <i class="fas fa-exchange-alt"></i>
                                    </button>
                                {% else %}
                                    <button class="btn-action btn-disabled tooltip-locked" 
                                            disabled 
                                            data-tooltip="A√±o bloqueado - Solo lectura">
                                        <i class="fas fa-lock"></i>
                                    </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7">
                            <div class="empty-state">
                                <i class="fas fa-user-graduate fa-3x"></i>
                                <p>No hay alumnos registrados para este a√±o acad√©mico.</p>
                                {% if permite_edicion %}
                                    <p>Para comenzar, crea un nuevo alumno usando el bot√≥n "Nuevo Alumno" en la parte superior.</p>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                    <tr id="no-results-row" style="display: none;">
                        <td colspan="7">
                            <div class="empty-state">
                                <i class="fas fa-search fa-3x"></i>
                                <p>No se encontraron resultados que coincidan con los criterios de b√∫squeda.</p>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    {% else %}
    <div class="empty-state">
        <i class="fas fa-user-graduate fa-3x"></i>
        <p>No hay alumnos registrados para el a√±o {{ ano_actual.ano }}. Para comenzar, crea un nuevo alumno usando el bot√≥n "Nuevo Alumno" en la parte superior.</p>
    </div>
    {% endif %}

    <!-- Agregar despu√©s de la tabla, reemplazar el div de paginaci√≥n existente -->
<div class="pagination-container" id="pagination-container">
    <div class="pagination-info">
        <span class="page-info" id="page-info">Mostrando 1-5 de 0 alumnos</span>
    </div>
    <div class="pagination-controls">
        <button class="pagination-btn" id="prev-btn" onclick="cambiarPagina('prev')" disabled>
            <i class="fas fa-chevron-left"></i> Anterior
        </button>
        <div class="pagination-numbers" id="pagination-numbers">
            <!-- Los n√∫meros de p√°gina se generar√°n din√°micamente -->
        </div>
        <button class="pagination-btn" id="next-btn" onclick="cambiarPagina('next')" disabled>
            Siguiente <i class="fas fa-chevron-right"></i>
        </button>
    </div>
    <div class="pagination-size">
        <label for="page-size-select">Mostrar:</label>
        <select id="page-size-select" class="form-select" onchange="cambiarTamanoPagina()">
            <option value="5">5 por p√°gina</option>
            <option value="10">10 por p√°gina</option>
            <option value="25">25 por p√°gina</option>
            <option value="50">50 por p√°gina</option>
        </select>
    </div>
</div>

<!-- Modal personalizado para cambiar estado -->
<div class="delete-alert-modal" id="estadoModal" style="display: none;">
    <div class="delete-alert-content">
        <div class="delete-alert-header">
            <h5><i class="fas fa-exchange-alt me-2"></i>Cambiar Estado del Alumno</h5>
            <button type="button" class="delete-alert-close" onclick="closeEstadoModal()">√ó</button>
        </div>
        <div class="delete-alert-body">
            <p>Seleccione el estado que desea establecer para <strong id="estado-modal-nombre"></strong> en el a√±o <strong id="estado-modal-ano">{{ ano_actual.ano }}</strong>:</p>
            
            <form id="estadoForm" method="post">
                {% csrf_token %}
                <input type="hidden" name="ano" value="{{ ano_actual.ano }}">
                
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="nuevo_estado" id="estadoActivo" value="activo">
                    <label class="form-check-label text-success" for="estadoActivo">
                        <i class="fas fa-check-circle me-2"></i>Activar Alumno
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="nuevo_estado" id="estadoInactivo" value="inactivo">
                    <label class="form-check-label text-danger" for="estadoInactivo">
                        <i class="fas fa-times-circle me-2"></i>Desactivar Alumno
                    </label>
                </div>
            </form>
        </div>
        <div class="delete-alert-footer">
            <button type="button" class="btn-cancel" onclick="closeEstadoModal()">
                <i class="fas fa-times me-1"></i>Cancelar
            </button>
            <button type="submit" form="estadoForm" class="btn-delete-confirm">
                <i class="fas fa-save me-1"></i>Guardar cambios
            </button>
        </div>
    </div>
</div>

<!-- Modal para confirmar activaci√≥n de a√±o acad√©mico -->
<div class="modal fade" id="activarAnoModal" tabindex="-1" aria-labelledby="activarAnoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="activarAnoModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>Activar A√±o Acad√©mico
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>¬°Atenci√≥n!</strong> Esta acci√≥n tendr√° las siguientes consecuencias:
                </div>
                
                <ul class="list-unstyled">
                    <li class="mb-2">
                        <i class="fas fa-unlock text-success me-2"></i>
                        El a√±o <strong id="ano-a-activar"></strong> se convertir√° en el a√±o acad√©mico activo
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-lock text-danger me-2"></i>
                        El a√±o activo actual se bloquear√° y pasar√° a modo solo lectura
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-edit text-primary me-2"></i>
                        Solo podr√°s realizar modificaciones en el a√±o <strong id="ano-a-activar-2"></strong>
                    </li>
                </ul>
                
                <div class="alert alert-info">
                    <i class="fas fa-lightbulb me-2"></i>
                    <strong>Recomendaci√≥n:</strong> Aseg√∫rate de haber terminado todas las tareas pendientes en el a√±o activo actual antes de proceder.
                </div>
                
                <form id="activarAnoForm">
                    {% csrf_token %}
                    <input type="hidden" id="ano-activar-input" name="ano">
                    
                    <div class="form-check mt-3">
                        <input class="form-check-input" type="checkbox" id="confirmarActivacion" required>
                        <label class="form-check-label" for="confirmarActivacion">
                            Entiendo las consecuencias y deseo activar este a√±o acad√©mico
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancelar
                </button>
                <button type="submit" form="activarAnoForm" class="btn btn-warning" id="btn-confirmar-activacion" disabled>
                    <i class="fas fa-unlock me-1"></i>Activar A√±o Acad√©mico
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para crear nuevo a√±o acad√©mico -->
<div class="modal fade" id="crearAnoModal" tabindex="-1" aria-labelledby="crearAnoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="crearAnoModalLabel">
                    <i class="fas fa-calendar-plus me-2"></i>Crear Nuevo A√±o Acad√©mico
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Al crear un nuevo a√±o acad√©mico, todos los alumnos activos del a√±o actual ser√°n transferidos como inactivos al nuevo a√±o.
                </div>
                
                <form id="crearAnoForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="nuevo-ano" class="form-label">A√±o Acad√©mico</label>
                        <input type="number" class="form-control" id="nuevo-ano" name="ano" 
                               min="2025" max="2050" required 
                               placeholder="Ej: {{ current_year|add:1 }}">
                        <div class="form-text">Ingrese el a√±o acad√©mico que desea crear</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" form="crearAnoForm" class="btn btn-primary">
                    <i class="fas fa-plus me-1"></i>Crear A√±o Acad√©mico
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Detalles Alumno -->
<div class="modal fade" id="alumnoDetallesModal" tabindex="-1" aria-labelledby="alumnoDetallesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="alumnoDetallesModalLabel">Detalles del Alumno</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="alumno-modal-loading" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-2">Cargando detalles del alumno...</p>
                </div>
                
                <div id="alumno-modal-content" style="display: none;">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-user-graduate me-2"></i>Informaci√≥n Personal</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <h6 class="fw-bold text-muted">Nombre Completo:</h6>
                                        <p id="alumno-nombre"></p>
                                    </div>
                                    <div class="mb-3">
                                        <h6 class="fw-bold text-muted">RUT:</h6>
                                        <p id="alumno-rut"></p>
                                    </div>
                                    <div class="mb-3">
                                        <h6 class="fw-bold text-muted">Fecha de Nacimiento:</h6>
                                        <p id="alumno-fecha-nacimiento"></p>
                                    </div>
                                    <div class="mb-3">
                                        <h6 class="fw-bold text-muted">Edad:</h6>
                                        <p id="alumno-edad"></p>
                                    </div>
                                    <div class="mb-3">
                                        <h6 class="fw-bold text-muted">Sexo:</h6>
                                        <p id="alumno-sexo"></p>
                                    </div>
                                    <div class="mb-3">
                                        <h6 class="fw-bold text-muted">Estado Civil:</h6>
                                        <p id="alumno-estado-civil"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-school me-2"></i>Informaci√≥n Acad√©mica</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <h6 class="fw-bold text-muted">Nivel:</h6>
                                        <p id="alumno-nivel"></p>
                                    </div>
                                    <div class="mb-3">
                                        <h6 class="fw-bold text-muted">Jornada:</h6>
                                        <p id="alumno-jornada"></p>
                                    </div>
                                    <div class="mb-3">
                                        <h6 class="fw-bold text-muted">Fecha de Ingreso:</h6>
                                        <p id="alumno-fecha-ingreso"></p>
                                    </div>
                                    <div class="mb-3">
                                        <h6 class="fw-bold text-muted">√öltimo Curso Aprobado:</h6>
                                        <p id="alumno-ultimo-curso"></p>
                                    </div>
                                    <div class="mb-3">
                                        <h6 class="fw-bold text-muted">Curso Repetido:</h6>
                                        <p id="alumno-curso-repetido"></p>
                                    </div>
                                    <div class="mb-3">
                                        <h6 class="fw-bold text-muted">Estado:</h6>
                                        <p id="alumno-estado"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-home me-2"></i>Informaci√≥n de Contacto</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <h6 class="fw-bold text-muted">Direcci√≥n:</h6>
                                        <p id="alumno-direccion"></p>
                                    </div>
                                    <div class="mb-3">
                                        <h6 class="fw-bold text-muted">Tel√©fono:</h6>
                                        <p id="alumno-telefono"></p>
                                    </div>
                                    <div class="mb-3">
                                        <h6 class="fw-bold text-muted">Correo Electr√≥nico:</h6>
                                        <p id="alumno-email"></p>
                                    </div>
                                    <div class="mb-3">
                                        <h6 class="fw-bold text-muted">Religi√≥n:</h6>
                                        <p id="alumno-religion"></p>
                                    </div>
                                    <div class="mb-3">
                                        <h6 class="fw-bold text-muted">Situaci√≥n Laboral:</h6>
                                        <p id="alumno-situacion-laboral"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Informaci√≥n Adicional</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <h6 class="fw-bold text-muted">Programa PIE:</h6>
                                        <p id="alumno-programa-pie"></p>
                                    </div>
                                    <div class="mb-3">
                                        <h6 class="fw-bold text-muted">Profesional de Apoyo:</h6>
                                        <p id="alumno-profesional-apoyo"></p>
                                    </div>
                                    <div class="mb-3">
                                        <h6 class="fw-bold text-muted">Informe Psicosocial:</h6>
                                        <p id="alumno-informe-psicosocial"></p>
                                    </div>
                                    <div class="mb-3">
                                        <h6 class="fw-bold text-muted">Diagn√≥stico:</h6>
                                        <p id="alumno-diagnostico"></p>
                                    </div>
                                    <div class="mb-3">
                                        <h6 class="fw-bold text-muted">Observaciones:</h6>
                                        <div id="alumno-observaciones" class="observaciones-modal"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-phone-alt me-2"></i>Contacto de Emergencia</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <h6 class="fw-bold text-muted">Nombre:</h6>
                                        <p id="alumno-contacto-emergencia-nombre"></p>
                                    </div>
                                    <div class="mb-3">
                                        <h6 class="fw-bold text-muted">Parentezco:</h6>
                                        <p id="alumno-contacto-emergencia-parentezco"></p>
                                    </div>
                                    <div class="mb-3">
                                        <h6 class="fw-bold text-muted">Tel√©fono:</h6>
                                        <p id="alumno-contacto-emergencia-telefono"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="alumno-modal-error" class="alert alert-danger" style="display: none;">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <span id="alumno-error-message">Error al cargar los detalles del alumno.</span>
                </div>
            </div>
            <div class="modal-footer">
                <div class="d-flex justify-content-between w-100">
                    <div>
                        <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cerrar</button>
                        {% if permite_edicion %}
                            <a href="#" id="editar-alumno-link" class="btn btn-eduvia btn-primary">
                                <i class="fas fa-edit me-1"></i> Editar Alumno
                            </a>
                        {% else %}
                            <span class="text-muted">
                                <i class="fas fa-lock me-1"></i>Edici√≥n bloqueada
                            </span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmaci√≥n para eliminar alumno -->
<div class="modal fade" id="confirmarEliminarAlumnoModal" tabindex="-1" aria-labelledby="confirmarEliminarAlumnoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="background-color: #e53935; color: white;">
                <h5 class="modal-title" id="confirmarEliminarAlumnoModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>Confirmar Eliminaci√≥n
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <i class="fas fa-exclamation-triangle fa-4x text-warning mb-3"></i>
                    <h5>¬øEst√°s seguro de que deseas eliminar este alumno?</h5>
                    <p class="text-danger">Esta acci√≥n no se puede deshacer y eliminar√° permanentemente toda la informaci√≥n asociada al alumno.</p>
                </div>
                <div class="alert alert-warning">
                    <strong>Alumno a eliminar:</strong> <span id="alumno-a-eliminar"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form id="form-eliminar-alumno" method="post" action="">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash-alt me-1"></i> Eliminar Definitivamente
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<form id="delete-form" method="post" style="display: none;">{% csrf_token %}</form>
<form id="delete-apoderado-form" method="post" style="display: none;">{% csrf_token %}</form>

<script>
function cambiarAno() {
    const yearSelect = document.getElementById('year-filter');
    const url = new URL(window.location);
    url.searchParams.set('year', yearSelect.value);
    // Limpiar otros filtros al cambiar a√±o
    url.searchParams.delete('nombre');
    url.searchParams.delete('nivel');
    url.searchParams.delete('estado');
    window.location.href = url.toString();
}

// Funci√≥n para limpiar filtros
function limpiarFiltros() {
    const anoActual = document.getElementById('year-filter').value;
    const url = new URL(window.location.origin + window.location.pathname);
    url.searchParams.set('year', anoActual); // Mantener solo el a√±o
    window.location.href = url.toString();
}

// Funci√≥n para activar a√±o acad√©mico
function activarAno(ano) {
    // Obtener el a√±o activo actual para mostrarlo en el mensaje
    const anoActivoActual = document.querySelector('#year-filter option[selected]')?.textContent || 'a√±o actual';
    
    Swal.fire({
        title: '<i class="fas fa-exclamation-triangle text-warning"></i> Activar A√±o Acad√©mico',
        html: `
            <div class="text-start">
                <div class="alert alert-warning mb-3">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>¬°Atenci√≥n!</strong> Esta acci√≥n tendr√° las siguientes consecuencias:
                </div>
                
                <ul class="list-unstyled mb-3">
                    <li class="mb-2">
                        <i class="fas fa-unlock text-success me-2"></i>
                        El a√±o <strong>${ano}</strong> se convertir√° en el a√±o acad√©mico activo
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-lock text-danger me-2"></i>
                        El a√±o activo actual se bloquear√° y pasar√° a modo solo lectura
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-edit text-primary me-2"></i>
                        Solo podr√°s realizar modificaciones en el a√±o <strong>${ano}</strong>
                    </li>
                </ul>
                
                <div class="alert alert-info mb-3">
                    <i class="fas fa-lightbulb me-2"></i>
                    <strong>Recomendaci√≥n:</strong> Aseg√∫rate de haber terminado todas las tareas pendientes en el a√±o activo actual antes de proceder.
                </div>
                
                <div class="form-check text-start">
                    <input class="form-check-input" type="checkbox" id="swal-confirmar-activacion">
                    <label class="form-check-label" for="swal-confirmar-activacion">
                        Entiendo las consecuencias y deseo activar este a√±o acad√©mico
                    </label>
                </div>
            </div>
        `,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: '<i class="fas fa-unlock me-1"></i>Activar A√±o Acad√©mico',
        cancelButtonText: '<i class="fas fa-times me-1"></i>Cancelar',
        confirmButtonColor: '#ffc107',
        cancelButtonColor: '#6c757d',
        width: '600px',
        preConfirm: () => {
            const checkbox = document.getElementById('swal-confirmar-activacion');
            if (!checkbox.checked) {
                Swal.showValidationMessage('Debes confirmar que entiendes las consecuencias');
                return false;
            }
            return true;
        }
    }).then((result) => {
        if (result.isConfirmed) {
            // Confirmaci√≥n final
            Swal.fire({
                title: '¬øProceder con la activaci√≥n?',
                html: `
                    <div class="text-center">
                        <i class="fas fa-exchange-alt fa-3x text-warning mb-3"></i>
                        <p>El a√±o acad√©mico <strong>${ano}</strong> ser√° activado inmediatamente.</p>
                        <p class="text-muted">Esta acci√≥n no se puede deshacer f√°cilmente.</p>
                    </div>
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: '<i class="fas fa-check me-1"></i>S√≠, activar ahora',
                cancelButtonText: 'Cancelar',
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#6c757d'
            }).then((confirmResult) => {
                if (confirmResult.isConfirmed) {
                    // Crear el formulario y enviarlo
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = '{% url "alumnos:activar_ano_academico" %}';
                    
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                    const csrfInput = document.createElement('input');
                    csrfInput.type = 'hidden';
                    csrfInput.name = 'csrfmiddlewaretoken';
                    csrfInput.value = csrfToken;
                    form.appendChild(csrfInput);
                    
                    const anoInput = document.createElement('input');
                    anoInput.type = 'hidden';
                    anoInput.name = 'ano';
                    anoInput.value = ano;
                    form.appendChild(anoInput);
                    
                    // Mostrar loading
                    Swal.fire({
                        title: 'Activando a√±o acad√©mico...',
                        html: `
                            <div class="text-center">
                                <i class="fas fa-sync fa-spin fa-2x text-primary mb-3"></i>
                                <p>Activando el a√±o acad√©mico <strong>${ano}</strong>...</p>
                                <p class="text-muted">Por favor espera, esto puede tomar unos momentos.</p>
                            </div>
                        `,
                        allowOutsideClick: false,
                        allowEscapeKey: false,
                        showConfirmButton: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });
                    
                    document.body.appendChild(form);
                    form.submit();
                }
            });
        }
    });
}

// Manejar env√≠o del formulario de crear a√±o
document.getElementById('crearAnoForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const ano = formData.get('ano');
    
    if (confirm(`¬øEst√°s seguro de que deseas crear el a√±o acad√©mico ${ano}?`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{% url "alumnos:crear_ano_academico" %}';
        
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrfToken;
        form.appendChild(csrfInput);
        
        const anoInput = document.createElement('input');
        anoInput.type = 'hidden';
        anoInput.name = 'ano';
        anoInput.value = ano;
        form.appendChild(anoInput);
        
        document.body.appendChild(form);
        form.submit();
    }
});

// Establecer el estado de permisos en el body
const permiteEdicion = document.querySelector('[data-permite-edicion]');
if (permiteEdicion) {
    document.body.dataset.permiteEdicion = permiteEdicion.dataset.permiteEdicion;
}

// Funci√≥n para abrir modal de estado
function openEstadoModal(button) {
    // Verificar si el a√±o permite edici√≥n desde el contenedor
    const container = document.querySelector('.user-list-container');
    const permiteEdicion = container ? container.dataset.permiteEdicion === 'true' : false;
    
    if (!permiteEdicion) {
        alert('No se pueden realizar cambios en este a√±o acad√©mico. Solo el a√±o activo permite modificaciones.');
        return;
    }
    
    currentAlumnoId = button.getAttribute('data-id');
    currentAlumnoNombre = button.getAttribute('data-nombre');
    currentAlumnoEstado = button.getAttribute('data-estado');
    
    // Actualizar el modal con los datos
    document.getElementById('estado-modal-nombre').textContent = currentAlumnoNombre;
    
    // Actualizar el a√±o en el modal
    const anoFilter = document.getElementById('year-filter').value;
    document.getElementById('estado-modal-ano').textContent = anoFilter;
    
    // Configurar el formulario
    document.getElementById('estadoForm').action = `/alumnos/${currentAlumnoId}/cambiar-estado/`;
    
    // Actualizar el campo oculto del a√±o
    const anoInput = document.querySelector('#estadoForm input[name="ano"]');
    if (anoInput) {
        anoInput.value = anoFilter;
    }
    
    // Seleccionar el radio button correspondiente al estado actual
    if (currentAlumnoEstado === 'Inactivo') {
        document.getElementById('estadoInactivo').checked = true;
    } else {
        document.getElementById('estadoActivo').checked = true;
    }
    
    // Mostrar el modal
    document.getElementById('estadoModal').style.display = 'flex';
}

function crearNuevoAno() {
    const currentYear = new Date().getFullYear();
    const nextYear = currentYear + 1;
    
    Swal.fire({
        title: '<i class="fas fa-calendar-plus"></i> Crear Nuevo A√±o Acad√©mico',
        html: `
            <div class="text-start">
                <div class="alert alert-info mb-3">
                    <i class="fas fa-info-circle me-2"></i>
                    Al crear un nuevo a√±o acad√©mico, todos los alumnos activos del a√±o actual ser√°n transferidos como inactivos al nuevo a√±o.
                </div>
                
                <div class="mb-3">
                    <label for="swal-nuevo-ano" class="form-label fw-bold">A√±o Acad√©mico</label>
                    <input type="number" class="form-control" id="swal-nuevo-ano" 
                           min="2025" max="2050" value="${nextYear}" 
                           placeholder="Ej: ${nextYear}">
                    <div class="form-text">Ingrese el a√±o acad√©mico que desea crear</div>
                </div>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: '<i class="fas fa-plus me-1"></i>Crear A√±o Acad√©mico',
        cancelButtonText: 'Cancelar',
        confirmButtonColor: '#007bff',
        cancelButtonColor: '#6c757d',
        width: '500px',
        preConfirm: () => {
            const ano = document.getElementById('swal-nuevo-ano').value;
            
            if (!ano) {
                Swal.showValidationMessage('Por favor ingrese un a√±o v√°lido');
                return false;
            }
            
            const anoInt = parseInt(ano);
            if (anoInt < 2025 || anoInt > 2050) {
                Swal.showValidationMessage('El a√±o debe estar entre 2025 y 2050');
                return false;
            }
            
            return { ano: anoInt };
        }
    }).then((result) => {
        if (result.isConfirmed) {
            // Mostrar confirmaci√≥n adicional
            Swal.fire({
                title: '¬øEst√°s seguro?',
                html: `
                    <div class="text-start">
                        <p>Se crear√° el a√±o acad√©mico <strong>${result.value.ano}</strong> con las siguientes caracter√≠sticas:</p>
                        <ul class="list-unstyled">
                            <li class="mb-2">
                                <i class="fas fa-calendar text-primary me-2"></i>
                                A√±o acad√©mico: <strong>${result.value.ano}</strong>
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-users text-info me-2"></i>
                                Los alumnos actuales ser√°n transferidos como inactivos
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-lock text-warning me-2"></i>
                                El nuevo a√±o se crear√° en estado inactivo
                            </li>
                        </ul>
                    </div>
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: '<i class="fas fa-check me-1"></i>S√≠, crear a√±o',
                cancelButtonText: 'Cancelar',
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#6c757d'
            }).then((confirmResult) => {
                if (confirmResult.isConfirmed) {
                    // Crear el formulario y enviarlo
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = '{% url "alumnos:crear_ano_academico" %}';
                    
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                    const csrfInput = document.createElement('input');
                    csrfInput.type = 'hidden';
                    csrfInput.name = 'csrfmiddlewaretoken';
                    csrfInput.value = csrfToken;
                    form.appendChild(csrfInput);
                    
                    const anoInput = document.createElement('input');
                    anoInput.type = 'hidden';
                    anoInput.name = 'ano';
                    anoInput.value = result.value.ano;
                    form.appendChild(anoInput);
                    
                    // Mostrar loading
                    Swal.fire({
                        title: 'Creando a√±o acad√©mico...',
                        html: 'Por favor espera mientras se crea el nuevo a√±o acad√©mico.',
                        allowOutsideClick: false,
                        allowEscapeKey: false,
                        showConfirmButton: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });
                    
                    document.body.appendChild(form);
                    form.submit();
                }
            });
        }
    });
}
</script>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="{% static 'js/alumnos/lista_alumnos.js' %}"></script>
<!-- NO uses lista_usuarios.js aqu√≠ -->
{% endblock %}