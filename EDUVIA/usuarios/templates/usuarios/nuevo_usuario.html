{% extends 'base.html' %}
{% load static %}

{% block title %}Nuevo Usuario - EDUVIA{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/nuevo_usuario.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    /* Estilos básicos del contenedor */
    .form-container {
        max-width: 900px;
        margin: 2rem auto;
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        animation: fadeInUp 0.6s ease-out;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Encabezado del formulario */
    .form-header {
        background: linear-gradient(135deg, #4e73df, #3d5fd8);
        color: white;
        padding: 2rem;
        text-align: center;
    }

    .form-header h2 {
        margin: 0;
        font-size: 1.8rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
    }

    .form-header p {
        margin: 0.75rem 0 0;
        opacity: 0.9;
        font-size: 1rem;
    }

    /* Formulario */
    .eduvia-form {
        padding: 2rem;
    }

    /* Secciones del formulario */
    .form-section {
        margin-bottom: 2.5rem;
        padding-bottom: 2rem;
        border-bottom: 1px solid #e9ecef;
    }

    .form-section:last-child {
        margin-bottom: 1rem;
        padding-bottom: 0;
        border-bottom: none;
    }

    .form-section h3 {
        color: #4e73df;
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid #e3f2fd;
    }

    /* Filas del formulario */
    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .form-row:last-child {
        margin-bottom: 0;
    }

    /* Grupos de formulario */
    .form-group {
        margin-bottom: 1.25rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: #495057;
        font-size: 0.9rem;
    }

    .required {
        color: #dc3545;
        margin-left: 0.25rem;
    }

    /* Input groups con iconos */
    .input-group {
        position: relative;
        display: flex;
        align-items: center;
    }

    .input-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
        font-size: 16px;
        z-index: 1;
        pointer-events: none;
        transition: color 0.3s ease;
    }

    .form-control {
        width: 100%;
        padding: 0.875rem 1rem 0.875rem 2.5rem;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        background: #fff;
        color: #495057;
        box-sizing: border-box;
    }

    .form-control:focus {
        outline: none;
        border-color: #4e73df;
        box-shadow: 0 0 0 3px rgba(78, 115, 223, 0.1);
    }

    .form-control:focus + .input-icon {
        color: #4e73df;
    }

    /* Estados de validación */
    .form-control.is-valid {
        border-color: #28a745;
        background-color: #f8fff9;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%2328a745' d='m2.3 6.73.94-.94 2.94 2.94L6.13 8.66 2.3 4.83z'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right calc(0.375em + 0.1875rem) center;
        background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
    }

    .form-control.is-valid + .input-icon {
        color: #28a745;
    }

    .form-control.is-invalid {
        border-color: #dc3545;
        background-color: #fff5f5;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right calc(0.375em + 0.1875rem) center;
        background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
    }

    .form-control.is-invalid + .input-icon {
        color: #dc3545;
    }

    /* Feedback messages */
    .valid-feedback {
        display: none;
        width: 100%;
        margin-top: 0.25rem;
        font-size: 0.875em;
        color: #28a745;
        font-weight: 500;
    }

    .invalid-feedback {
        display: none;
        width: 100%;
        margin-top: 0.25rem;
        font-size: 0.875em;
        color: #dc3545;
        font-weight: 500;
    }

    .form-control.is-valid ~ .valid-feedback {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .form-control.is-invalid ~ .invalid-feedback {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    /* Selectores de rol */
    .selector-group {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        flex-wrap: wrap;
    }
    
    .selector-btn {
        padding: 12px 18px;
        border: 2px solid #ddd;
        border-radius: 8px;
        background-color: #f8f9fa;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
        user-select: none;
        min-width: 140px;
        justify-content: center;
    }
    
    .selector-btn:hover {
        border-color: #4e73df;
        background-color: #e7f3ff;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .selector-btn.active {
        background: linear-gradient(135deg, #4e73df, #3d5fd8);
        color: white;
        border-color: #4e73df;
        box-shadow: 0 4px 12px rgba(78, 115, 223, 0.3);
    }

    .selector-btn.active:hover {
        background: linear-gradient(135deg, #3d5fd8, #2e4bc7);
    }

    .selector-btn i {
        font-size: 16px;
    }

    /* Texto de ayuda */
    .form-text {
        display: block;
        margin-top: 0.5rem;
        font-size: 0.75rem;
        color: #6c757d;
    }

    /* Alertas */
    .alert {
        padding: 1rem;
        margin-bottom: 1rem;
        border: 1px solid transparent;
        border-radius: 0.5rem;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .alert-danger {
        color: #721c24;
        background-color: #f8d7da;
        border-color: #f5c6cb;
    }
    
    .alert-success {
        color: #155724;
        background-color: #d4edda;
        border-color: #c3e6cb;
    }

    /* Texto informativo */
    .info-text {
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 3px solid #4e73df;
        font-size: 0.875rem;
        color: #495057;
        margin-top: 1.5rem;
    }

    .info-text i {
        color: #4e73df;
        font-size: 1rem;
        margin-top: 0.125rem;
    }

    /* Botones de acción */
    .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 1px solid #dee2e6;
    }

    .btn-eduvia {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
        font-size: 0.95rem;
        text-decoration: none;
    }

    .btn-primary {
        background: linear-gradient(135deg, #4e73df, #3d5fd8);
        color: white;
        box-shadow: 0 4px 10px rgba(78, 115, 223, 0.3);
    }

    .btn-primary:hover {
        background: linear-gradient(135deg, #3d5fd8, #2e4bc7);
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(78, 115, 223, 0.4);
    }

    .btn-secondary {
        background: #fff;
        color: #6c757d;
        border: 1px solid #dee2e6;
    }

    .btn-secondary:hover {
        background: #f8f9fa;
        color: #495057;
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    /* Error styling */
    #error-rol {
        color: #dc3545;
        display: none;
        margin-top: 8px;
        font-size: 0.875rem;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .form-container {
            margin: 1rem;
            border-radius: 8px;
        }
        
        .form-header {
            padding: 1.5rem;
        }
        
        .form-header h2 {
            font-size: 1.5rem;
        }
        
        .eduvia-form {
            padding: 1.5rem;
        }
        
        .form-row {
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        
        .form-actions {
            flex-direction: column-reverse;
            gap: 0.75rem;
        }
        
        .btn-eduvia {
            width: 100%;
            justify-content: center;
        }

        .selector-group {
            flex-direction: column;
        }

        .selector-btn {
            min-width: auto;
        }
    }

    /* Utilidades */
    .mt-3 { margin-top: 1rem; }
    .mb-3 { margin-bottom: 1rem; }
</style>
{% endblock %}

{% block content %}
<div class="form-container">
    <div class="form-header">
        <h2><i class="fas fa-user-plus"></i> Crear Nuevo Usuario</h2>
        <p>Complete el formulario para registrar un nuevo usuario en el sistema.</p>
    </div>

    <!-- Mostrar mensajes -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">
                <i class="fas fa-{% if message.tags == 'error' %}exclamation-triangle{% elif message.tags == 'success' %}check-circle{% else %}info-circle{% endif %}"></i>
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <form method="post" class="eduvia-form" id="userForm" action="{% url 'usuarios:nuevo_usuario' %}">
        {% csrf_token %}
        
        <!-- Sección: Información Personal -->
        <div class="form-section">
            <h3><i class="fas fa-user"></i> Información Personal</h3>
            
            <!-- Campo RUT -->
            <div class="form-row">
                <div class="form-group">
                    <label for="rut">RUT <span class="required">*</span></label>
                    <div class="input-group">
                        <span class="input-icon"><i class="fas fa-id-card"></i></span>
                        <input type="text" id="rut" name="rut" class="form-control" placeholder="Ej: 12.345.678-9" maxlength="12" required>
                    </div>
                    <small class="form-text">Formato: 12.345.678-9 (8 dígitos + dígito verificador)</small>
                    <div class="valid-feedback">
                        <i class="fas fa-check-circle"></i> RUT válido
                    </div>
                    <div class="invalid-feedback">
                        <i class="fas fa-exclamation-circle"></i> RUT debe tener 8 dígitos + dígito verificador válido
                    </div>
                </div>
            </div>
            
            <!-- Campo de contraseña -->
            <div class="form-row">
                <div class="form-group">
                    <label for="password">Contraseña <span class="required">*</span></label>
                    <div class="input-group">
                        <span class="input-icon"><i class="fas fa-lock"></i></span>
                        <input type="password" id="password" name="password" class="form-control" placeholder="Contraseña" required>
                    </div>
                    <small class="form-text">Mínimo 6 caracteres</small>
                    <div class="valid-feedback">
                        <i class="fas fa-check-circle"></i> Contraseña válida
                    </div>
                    <div class="invalid-feedback">
                        <i class="fas fa-exclamation-circle"></i> La contraseña debe tener al menos 6 caracteres
                    </div>
                </div>
            </div>
            
            <!-- Nombres y Apellidos -->
            <div class="form-row">
                <div class="form-group">
                    <label for="nombres">Nombres <span class="required">*</span></label>
                    <div class="input-group">
                        <span class="input-icon"><i class="fas fa-user"></i></span>
                        <input type="text" id="nombres" name="nombres" class="form-control" placeholder="Ingrese nombres" required>
                    </div>
                    <div class="valid-feedback">
                        <i class="fas fa-check-circle"></i> Nombres válidos
                    </div>
                    <div class="invalid-feedback">
                        <i class="fas fa-exclamation-circle"></i> Los nombres son requeridos
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="apellidos">Apellidos <span class="required">*</span></label>
                    <div class="input-group">
                        <span class="input-icon"><i class="fas fa-user"></i></span>
                        <input type="text" id="apellidos" name="apellidos" class="form-control" placeholder="Ingrese apellidos" required>
                    </div>
                    <div class="valid-feedback">
                        <i class="fas fa-check-circle"></i> Apellidos válidos
                    </div>
                    <div class="invalid-feedback">
                        <i class="fas fa-exclamation-circle"></i> Los apellidos son requeridos
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sección: Información de Contacto -->
        <div class="form-section">
            <h3><i class="fas fa-address-book"></i> Información de Contacto</h3>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="telefono">Número de Teléfono</label>
                    <div class="input-group">
                        <span class="input-icon"><i class="fas fa-phone"></i></span>
                        <input type="tel" id="telefono" name="telefono" class="form-control" placeholder="Ej: +56 9 1234 5678" value="+56 9 ">
                    </div>
                    <small class="form-text">Formato: +56 9 1234 5678 (8 dígitos después del prefijo)</small>
                    <div class="valid-feedback">
                        <i class="fas fa-check-circle"></i> Teléfono válido
                    </div>
                    <div class="invalid-feedback">
                        <i class="fas fa-exclamation-circle"></i> Formato inválido. Use: +56 9 1234 5678
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="correo">Correo Electrónico <span class="required">*</span></label>
                    <div class="input-group">
                        <span class="input-icon"><i class="fas fa-envelope"></i></span>
                        <input type="email" id="correo" name="correo" class="form-control" placeholder="ejemplo@dominio.com" required>
                    </div>
                    <div class="valid-feedback">
                        <i class="fas fa-check-circle"></i> Correo válido
                    </div>
                    <div class="invalid-feedback">
                        <i class="fas fa-exclamation-circle"></i> Ingrese un correo electrónico válido
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sección: Información del Sistema -->
        <div class="form-section">
            <h3><i class="fas fa-cogs"></i> Información del Sistema</h3>
            
            <!-- Selector de rol -->
            <div class="form-row">
                <div class="form-group">
                    <label>Rol <span class="required">*</span></label>
                    <div class="selector-group">
                        <div class="selector-btn" data-rol="usuario" id="btn-rol-usuario">
                            <i class="fas fa-user-tie"></i>
                            <span>Usuario</span>
                        </div>
                        <div class="selector-btn" data-rol="admin" id="btn-rol-admin">
                            <i class="fas fa-user-shield"></i>
                            <span>Administrador</span>
                        </div>
                    </div>
                    <input type="hidden" name="rol" id="rol" value="" required>
                    <small class="form-text">Usuario: acceso estándar | Administrador: acceso completo</small>
                    <div id="error-rol">
                        <i class="fas fa-exclamation-triangle"></i> Debe seleccionar un rol para el usuario
                    </div>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="funcion">Función</label>
                    <div class="input-group">
                        <span class="input-icon"><i class="fas fa-briefcase"></i></span>
                        <input type="text" id="funcion" name="funcion" class="form-control" placeholder="Ej: Profesor de Matemáticas">
                    </div>
                    <small class="form-text">Especifique la función o cargo del usuario</small>
                    <div class="valid-feedback">
                        <i class="fas fa-check-circle"></i> Función válida
                    </div>
                </div>
            </div>
            
            <input type="hidden" name="estado" value="inactive">
            
            <div class="info-text mt-3">
                <i class="fas fa-info-circle"></i>
                <span>Los nuevos usuarios se crean con estado "Inactivo" por defecto.</span>
            </div>
        </div>
        
        <div class="form-actions">
            <a href="{% url 'usuarios:lista_usuarios' %}" class="btn-eduvia btn-secondary">
                <i class="fas fa-times"></i> Cancelar
            </a>
            <button type="submit" class="btn-eduvia btn-primary" id="btn-submit">
                <i class="fas fa-save"></i> Guardar Usuario
            </button>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Elementos del DOM
    const btnRolUsuario = document.getElementById('btn-rol-usuario');
    const btnRolAdmin = document.getElementById('btn-rol-admin');
    const rolInput = document.getElementById('rol');
    const errorRol = document.getElementById('error-rol');
    const userForm = document.getElementById('userForm');
    const btnSubmit = document.getElementById('btn-submit');
    
    // Inputs para validación
    const rutInput = document.getElementById('rut');
    const passwordInput = document.getElementById('password');
    const nombresInput = document.getElementById('nombres');
    const apellidosInput = document.getElementById('apellidos');
    const telefonoInput = document.getElementById('telefono');
    const correoInput = document.getElementById('correo');
    const funcionInput = document.getElementById('funcion');
    
    // Función para validar RUT chileno (exactamente 8 dígitos + DV)
    function validarRut(rut) {
        // Limpiar RUT
        rut = rut.replace(/[^0-9kK]/g, '').toUpperCase();
        
        // Debe tener exactamente 9 caracteres (8 dígitos + 1 DV)
        if (rut.length !== 9) {
            return false;
        }
        
        // Separar número y dígito verificador
        const numero = rut.slice(0, 8);
        const dv = rut.slice(8);
        
        // Verificar que los primeros 8 sean números
        if (!/^\d{8}$/.test(numero)) {
            return false;
        }
        
        // Calcular dígito verificador
        let suma = 0;
        let multiplicador = 2;
        
        for (let i = numero.length - 1; i >= 0; i--) {
            suma += parseInt(numero.charAt(i)) * multiplicador;
            multiplicador = multiplicador === 7 ? 2 : multiplicador + 1;
        }
        
        const resto = suma % 11;
        const dvCalculado = resto < 2 ? resto.toString() : resto === 10 ? 'K' : (11 - resto).toString();
        
        return dv === dvCalculado;
    }
    
    // Función para formatear RUT
    function formatearRut(rut) {
        // Eliminar todo excepto números y K
        rut = rut.replace(/[^0-9kK]/g, '').toUpperCase();
        
        if (rut.length <= 1) {
            return rut;
        }
        
        // Separar dígito verificador
        const dv = rut.slice(-1);
        let numero = rut.slice(0, -1);
        
        // Agregar puntos cada 3 dígitos desde la derecha
        numero = numero.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        
        // Retornar con guión
        return numero + '-' + dv;
    }
    
    // Función para validar email
    function validarEmail(email) {
        const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return regex.test(email);
    }
    
    // Función para validar teléfono chileno
    function validarTelefono(telefono) {
        // Debe coincidir exactamente con +56 9 seguido de 8 dígitos
        const regex = /^\+56 9 \d{4} \d{4}$/;
        return regex.test(telefono);
    }
    
    // Función para formatear teléfono
    function formatearTelefono(telefono) {
        // Si no empieza con +56 9, mantener el prefijo
        if (!telefono.startsWith('+56 9 ')) {
            return '+56 9 ';
        }
        
        // Extraer solo los números después del prefijo
        const numeros = telefono.replace('+56 9 ', '').replace(/\D/g, '');
        
        // Formatear: +56 9 1234 5678
        if (numeros.length <= 4) {
            return '+56 9 ' + numeros;
        } else {
            return '+56 9 ' + numeros.slice(0, 4) + ' ' + numeros.slice(4, 8);
        }
    }
    
    // Función para validar y marcar input
    function validarInput(input, validacionFn, esOpcional = false) {
        const valor = input.value.trim();
        
        if (esOpcional && valor === '') {
            input.classList.remove('is-valid', 'is-invalid');
            return true;
        }
        
        if (!esOpcional && valor === '') {
            input.classList.remove('is-valid');
            input.classList.add('is-invalid');
            return false;
        }
        
        if (validacionFn(valor)) {
            input.classList.remove('is-invalid');
            input.classList.add('is-valid');
            return true;
        } else {
            input.classList.remove('is-valid');
            input.classList.add('is-invalid');
            return false;
        }
    }
    
    // Event listeners para validación en tiempo real
    
    // RUT
    rutInput.addEventListener('input', function() {
        const cursorPosition = this.selectionStart;
        const oldValue = this.value;
        const newValue = formatearRut(oldValue);
        
        this.value = newValue;
        
        // Mantener posición del cursor
        const diff = newValue.length - oldValue.length;
        this.setSelectionRange(cursorPosition + diff, cursorPosition + diff);
        
        // Validar
        validarInput(this, validarRut);
    });
    
    // Contraseña
    passwordInput.addEventListener('input', function() {
        validarInput(this, (valor) => valor.length >= 6);
    });
    
    // Nombres
    nombresInput.addEventListener('input', function() {
        validarInput(this, (valor) => valor.length >= 2);
    });
    
    // Apellidos
    apellidosInput.addEventListener('input', function() {
        validarInput(this, (valor) => valor.length >= 2);
    });
    
    // Teléfono
    telefonoInput.addEventListener('input', function() {
        this.value = formatearTelefono(this.value);
        validarInput(this, validarTelefono, true); // Es opcional
    });
    
    // Correo
    correoInput.addEventListener('input', function() {
        validarInput(this, validarEmail);
    });
    
    // Función (opcional)
    funcionInput.addEventListener('input', function() {
        if (this.value.trim() !== '') {
            this.classList.remove('is-invalid');
            this.classList.add('is-valid');
        } else {
            this.classList.remove('is-valid', 'is-invalid');
        }
    });
    
    // Función para seleccionar rol
    function selectRol(rol) {
        btnRolUsuario.classList.remove('active');
        btnRolAdmin.classList.remove('active');
        
        if (rol === 'usuario') {
            btnRolUsuario.classList.add('active');
            rolInput.value = 'usuario';
        } else if (rol === 'admin') {
            btnRolAdmin.classList.add('active');
            rolInput.value = 'admin';
        }
        
        errorRol.style.display = 'none';
    }
    
    // Event listeners para rol
    btnRolUsuario.addEventListener('click', function(e) {
        e.preventDefault();
        selectRol('usuario');
    });
    
    btnRolAdmin.addEventListener('click', function(e) {
        e.preventDefault();
        selectRol('admin');
    });
    
    // Validación del formulario
    userForm.addEventListener('submit', function(e) {
        let isValid = true;
        
        // Validar rol
        if (!rolInput.value) {
            e.preventDefault();
            errorRol.style.display = 'block';
            alert('Debe seleccionar un rol para el usuario');
            isValid = false;
            return false;
        }
        
        // Validar todos los campos requeridos
        const validaciones = [
            { input: rutInput, fn: validarRut, nombre: 'RUT' },
            { input: passwordInput, fn: (valor) => valor.length >= 6, nombre: 'contraseña' },
            { input: nombresInput, fn: (valor) => valor.length >= 2, nombre: 'nombres' },
            { input: apellidosInput, fn: (valor) => valor.length >= 2, nombre: 'apellidos' },
            { input: correoInput, fn: validarEmail, nombre: 'correo electrónico' }
        ];
        
        for (let validacion of validaciones) {
            if (!validarInput(validacion.input, validacion.fn)) {
                e.preventDefault();
                alert(`El campo ${validacion.nombre} no es válido`);
                validacion.input.focus();
                isValid = false;
                return false;
            }
        }
        
        // Validar teléfono si tiene valor
        if (telefonoInput.value.trim() !== '+56 9 ' && telefonoInput.value.trim() !== '') {
            if (!validarTelefono(telefonoInput.value)) {
                e.preventDefault();
                telefonoInput.classList.add('is-invalid');
                alert('El formato del teléfono no es válido');
                telefonoInput.focus();
                return false;
            }
        }
        
        if (isValid) {
            btnSubmit.disabled = true;
            btnSubmit.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
        }
        
        return isValid;
    });
    
    // Inicializar teléfono con prefijo
    if (telefonoInput.value.trim() === '') {
        telefonoInput.value = '+56 9 ';
    }
});
</script>
{% endblock %}