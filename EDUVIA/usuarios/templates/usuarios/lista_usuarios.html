{% extends 'base.html' %}
{% load static %}

{% block title %}Listado de Usuarios - EDUVIA{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/lista_usuarios.css' %}">

{% endblock %}
{% block content %}
<div class="user-list-container">
    <!-- Encabezado de la página -->
    <div class="page-header">
        <h2>Listado de Usuarios</h2>
        <a href="{% url 'usuarios:nuevo_usuario' %}" class="btn-eduvia btn-primary">
            <i class="fas fa-plus-circle"></i> Nuevo Usuario
        </a>
    </div>
    
    <!-- Contenedor para alertas dinámicas -->
    <div id="alertContainer"></div>

    <!-- Alertas de Django Messages -->
    {% if messages %}
        {% for message in messages %}
            <div class="custom-alert alert-{{ message.tags }}" id="djangoAlert">
                <div class="alert-content">
                    {% if message.tags == 'success' %}
                        <i class="fas fa-check-circle alert-icon"></i>
                    {% elif message.tags == 'error' %}
                        <i class="fas fa-exclamation-circle alert-icon"></i>
                    {% endif %}
                    <span class="alert-message">{{ message }}</span>
                </div>
                <button type="button" class="alert-close" onclick="closeAlert(this)">×</button>
            </div>
        {% endfor %}
    {% endif %}
    
    {% if usuarios %}
    <!-- Búsqueda y filtros - Versión compacta -->
    <div class="search-filter-container compact-filters">
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" class="form-control search-input" placeholder="Buscar...">
        </div>
        <div class="filter-group">
            <select class="form-select filter-dropdown filter-rol">
                <option value="">Rol</option>
                {% regroup usuarios by get_rol_display as rol_list %}
                {% for rol_group in rol_list %}
                    <option value="{{ rol_group.grouper.0 }}">{{ rol_group.grouper }}</option>
                {% endfor %}
            </select>
            <select class="form-select filter-dropdown filter-estado">
                <option value="">Estado</option>
                {% regroup usuarios by get_estado_display as estado_list %}
                {% for estado_group in estado_list %}
                    <option value="{{ estado_group.grouper.0 }}">{{ estado_group.grouper }}</option>
                {% endfor %}
            </select>
        </div>
    </div>
    {% endif %}
    
    <!-- Tabla de usuarios -->
    <div class="table-responsive">
        <table class="user-table">
            <thead>
                <tr>
                    <th>RUT</th>
                    <th>Nombres</th>
                    <th>Apellidos</th>
                    <th>Rol</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for usuario in usuarios %}
                <tr>
                    <td>{{ usuario.rut }}</td>
                    <td>{{ usuario.nombres }}</td>
                    <td>{{ usuario.apellidos }}</td>
                    <td data-rol="{{ usuario.rol }}">
                        {% if usuario.rol == 'admin' %}
                            <span class="role-badge role-admin"><i class="fas fa-user-shield"></i> Administrador</span>
                        {% elif usuario.rol == 'teacher' %}
                            <span class="role-badge role-teacher"><i class="fas fa-chalkboard-teacher"></i> Profesor</span>
                        {% elif usuario.rol == 'student' %}
                            <span class="role-badge role-student"><i class="fas fa-user-graduate"></i> Estudiante</span>
                        {% else %}
                            <span class="role-badge role-staff"><i class="fas fa-user"></i> Personal</span>
                        {% endif %}
                    </td>
                    <td data-estado="{{ usuario.estado }}">
                        {% if usuario.estado == 'active' %}
                            <span class="status-badge status-active">Activo</span>
                        {% elif usuario.estado == 'inactive' %}
                            <span class="status-badge status-inactive">Inactivo</span>
                        {% else %}
                            <span class="status-badge status-pending">Pendiente</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button type="button" class="btn-action btn-view" 
                                    data-id="{{ usuario.id }}"
                                    data-rut="{{ usuario.rut|default:'' }}"
                                    data-nombres="{{ usuario.nombres|default:'' }}"
                                    data-apellidos="{{ usuario.apellidos|default:'' }}"
                                    data-correo="{{ usuario.correo|default:'' }}"
                                    data-telefono="{{ usuario.telefono|default:'' }}"
                                    data-rol="{{ usuario.rol|default:'usuario' }}"
                                    data-estado="{{ usuario.estado|default:'inactive' }}"
                                    data-funcion="{{ usuario.funcion|default:'' }}"
                                    data-fecha="{{ usuario.fecha_creacion|date:'d/m/Y H:i'|default:'-' }}"
                                    onclick="showDetailModal(this)">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button type="button" class="btn-action btn-delete" 
                                    data-id="{{ usuario.id }}" 
                                    data-nombre="{{ usuario.nombres }} {{ usuario.apellidos }}"
                                    data-rut="{{ usuario.rut }}"
                                    onclick="showDeleteModal(this)">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                            <button type="button" class="btn-action btn-permissions" 
                                    data-id="{{ usuario.id }}" 
                                    data-nombre="{{ usuario.nombres }} {{ usuario.apellidos }}"
                                    data-rol="{{ usuario.rol }}"
                                    onclick="showPermissionsModal(this)"
                                    title="Asignar permisos">
                                <i class="fas fa-key"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="text-center py-4">
                        <div class="empty-state">
                            <i class="fas fa-users fa-3x text-muted mb-3"></i>
                            <p>No se encontraron usuarios. Para comenzar, crea un nuevo usuario usando el botón "Nuevo Usuario" en la parte superior.</p>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <!-- Mensaje cuando no hay resultados de búsqueda -->
        <div id="empty-results" style="display: none;" class="text-center py-4">
            <div class="empty-state">
                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                <p>No se encontraron usuarios que coincidan con los criterios de búsqueda.</p>
                <button class="btn btn-outline-primary mt-2" onclick="resetFilters()">
                    <i class="fas fa-undo"></i> Limpiar filtros
                </button>
            </div>
        </div>
    </div>
    
    {% if usuarios %}
    <!-- Paginación - Solo se muestra si hay usuarios -->
    <div class="pagination-container">
        <div class="page-info">
            Mostrando {{ usuarios.start_index }} a {{ usuarios.end_index }} de {{ usuarios.paginator.count }} usuarios
        </div>
        <ul class="pagination">
            {% if usuarios.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page=1" aria-label="Primera página" data-tooltip="Primera página">
                    <i class="fas fa-angle-double-left"></i>
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ usuarios.previous_page_number }}" aria-label="Página anterior" data-tooltip="Anterior">
                    <i class="fas fa-angle-left"></i>
                </a>
            </li>
            {% else %}
            <li class="page-item disabled">
                <span class="page-link"><i class="fas fa-angle-double-left"></i></span>
            </li>
            <li class="page-item disabled">
                <span class="page-link"><i class="fas fa-angle-left"></i></span>
            </li>
            {% endif %}
            
            {% for num in usuarios.paginator.page_range %}
                {% if usuarios.number == num %}
                <li class="page-item active">
                    <span class="page-link">{{ num }}</span>
                </li>
                {% elif num > usuarios.number|add:'-3' and num < usuarios.number|add:'3' %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                </li>
                {% endif %}
            {% endfor %}
            
            {% if usuarios.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ usuarios.next_page_number }}" aria-label="Siguiente página" data-tooltip="Siguiente">
                    <i class="fas fa-angle-right"></i>
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ usuarios.paginator.num_pages }}" aria-label="Última página" data-tooltip="Última página">
                    <i class="fas fa-angle-double-right"></i>
                </a>
            </li>
            {% else %}
            <li class="page-item disabled">
                <span class="page-link"><i class="fas fa-angle-right"></i></span>
            </li>
            <li class="page-item disabled">
                <span class="page-link"><i class="fas fa-angle-double-right"></i></span>
            </li>
            {% endif %}
        </ul>
    </div>
    {% endif %}
    
    <!-- Modal de confirmación para eliminar usuario -->
    <div class="delete-alert-modal" id="deleteModal" style="display: none;">
        <div class="delete-alert-content">
            <div class="delete-alert-header">
                <h5><i class="fas fa-exclamation-triangle me-2"></i>Confirmar eliminación</h5>
                <button type="button" class="delete-alert-close" onclick="closeDeleteModal()">×</button>
            </div>
            <div class="delete-alert-body">
                <div class="text-center mb-3">
                    <i class="fas fa-user-times fa-3x text-danger mb-3"></i>
                    <p>¿Está seguro que desea eliminar al usuario?</p>
                    <p class="fw-bold" id="userName">Nombre del Usuario</p>
                    <p><strong>RUT:</strong> <span id="userRut"></span></p>
                </div>
                <div class="delete-alert-warning">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <span>Esta acción no se puede deshacer. Todos los datos del usuario serán eliminados permanentemente.</span>
                </div>
            </div>
            <div class="delete-alert-footer">
                <button type="button" class="btn-cancel" onclick="closeDeleteModal()">
                    <i class="fas fa-times me-1"></i>Cancelar
                </button>
                <form id="deleteForm" method="POST" action="" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn-delete-confirm">
                        <i class="fas fa-trash-alt me-1"></i>Eliminar Usuario
                    </button>
                </form>
            </div>
        </div>
    </div>
    <!-- Modal de detalles/edición del usuario -->
    <div class="detail-modal" id="detailModal" style="display: none;">
        <div class="detail-modal-content">
            <div class="detail-modal-header">
                <h5 id="modalTitle"><i class="fas fa-user-circle me-2"></i>Detalles del Usuario</h5>
                <button type="button" class="detail-modal-close" onclick="closeDetailModal()">×</button>
            </div>
            <div class="detail-modal-body">
                <div class="user-avatar">
                    <i class="fas fa-user-circle fa-3x text-primary"></i>
                    <h4 id="detailUserName">Nombre del Usuario</h4>
                    <span id="detailUserRole" class="role-badge">Rol</span>
                </div>
            
                <form id="editUserForm" method="POST" style="display: none;">
                    {% csrf_token %}
                    <div class="detail-sections">
                        <!-- Información Personal -->
                        <div class="detail-section">
                            <h6><i class="fas fa-user"></i> Información Personal</h6>
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <label>RUT:</label>
                                    <input type="text" id="editRut" name="rut" class="form-control-modal" maxlength="12">
                                    <div class="invalid-feedback" id="edit-rut-error"></div>
                                </div>
                                <div class="detail-item">
                                    <label>Nombres:</label>
                                    <input type="text" id="editNombres" name="nombres" class="form-control-modal" required>
                                    <div class="invalid-feedback" id="edit-nombres-error"></div>
                                </div>
                                <div class="detail-item">
                                    <label>Apellidos:</label>
                                    <input type="text" id="editApellidos" name="apellidos" class="form-control-modal" required>
                                    <div class="invalid-feedback" id="edit-apellidos-error"></div>
                                </div>
                            </div>
                        </div>
                    
                        <!-- Información de Contacto -->
                        <div class="detail-section">
                            <h6><i class="fas fa-address-book"></i> Información de Contacto</h6>
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <label>Correo Electrónico:</label>
                                    <input type="email" id="editCorreo" name="correo" class="form-control-modal" required>
                                    <div class="invalid-feedback" id="edit-correo-error"></div>
                                </div>
                                <div class="detail-item">
                                    <label>Teléfono:</label>
                                    <input type="tel" id="editTelefono" name="telefono" class="form-control-modal" maxlength="16">
                                    <div class="invalid-feedback" id="edit-telefono-error"></div>
                                </div>
                            </div>
                        </div>
                    
                        <!-- Información del Sistema -->
                        <div class="detail-section">
                            <h6><i class="fas fa-cogs"></i> Información del Sistema</h6>
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <label>Rol:</label>
                                    <select id="editRol" name="rol" class="form-control-modal" required>
                                        <option value="usuario">Usuario</option>
                                        <option value="admin">Administrador</option>
                                    </select>
                                </div>
                                <div class="detail-item">
                                    <label>Estado:</label>
                                    <select id="editEstado" name="estado" class="form-control-modal" required>
                                        <option value="active">Activo</option>
                                        <option value="inactive">Inactivo</option>
                                        <option value="pending">Pendiente</option>
                                    </select>
                                </div>
                                <div class="detail-item">
                                    <label>Función:</label>
                                    <input type="text" id="editFuncion" name="funcion" class="form-control-modal">
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            
                <!-- Vista de solo lectura -->
                <div id="readOnlyView" class="detail-sections">
                    <!-- Información Personal -->
                    <div class="detail-section">
                        <h6><i class="fas fa-user"></i> Información Personal</h6>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <label>RUT:</label>
                                <span id="detailRut">-</span>
                            </div>
                            <div class="detail-item">
                                <label>Nombres:</label>
                                <span id="detailNombres">-</span>
                            </div>
                            <div class="detail-item">
                                <label>Apellidos:</label>
                                <span id="detailApellidos">-</span>
                            </div>
                        </div>
                    </div>
                
                    <!-- Información de Contacto -->
                    <div class="detail-section">
                        <h6><i class="fas fa-address-book"></i> Información de Contacto</h6>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <label>Correo Electrónico:</label>
                                <span id="detailCorreo">-</span>
                            </div>
                            <div class="detail-item">
                                <label>Teléfono:</label>
                                <span id="detailTelefono">-</span>
                            </div>
                        </div>
                    </div>
                
                    <!-- Información del Sistema -->
                    <div class="detail-section">
                        <h6><i class="fas fa-cogs"></i> Información del Sistema</h6>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <label>Estado:</label>
                                <span id="detailEstado" class="status-badge">-</span>
                            </div>
                            <div class="detail-item">
                                <label>Función:</label>
                                <span id="detailFuncion">-</span>
                            </div>
                            <div class="detail-item">
                                <label>Fecha de Registro:</label>
                                <span id="detailFechaRegistro">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="detail-modal-footer">
                <button type="button" class="btn-secondary" onclick="closeDetailModal()">
                    <i class="fas fa-times me-1"></i>Cerrar
                </button>
                <!-- POR esta línea: -->
                <button type="button" class="btn-primary" id="editBtn" onclick="redirectToEdit()">
                    <i class="fas fa-edit me-1"></i>Editar Usuario
                </button>
                <button type="button" class="btn-secondary" id="cancelBtn" onclick="cancelEdit()" style="display: none;">
                    <i class="fas fa-times me-1"></i>Cancelar
                </button>
                <button type="button" class="btn-success" id="saveBtn" onclick="saveUser()" style="display: none;">
                    <i class="fas fa-save me-1"></i>Guardar Cambios
                </button>
            </div>
        </div>
    </div>
    <!-- Modal de edición del usuario -->
    <div class="edit-modal" id="editModal" style="display: none;">
        <div class="edit-modal-content">
            <div class="edit-modal-header">
                <h5><i class="fas fa-user-edit me-2"></i>Editar Usuario</h5>
                <button type="button" class="edit-modal-close" onclick="closeEditModal()">×</button>
            </div>
            <form id="editUserForm" method="POST">
                {% csrf_token %}
                <div class="edit-modal-body">
                    <div class="edit-sections">
                        <!-- Información Personal -->
                        <div class="edit-section">
                            <h6><i class="fas fa-user"></i> Información Personal</h6>
                            <div class="edit-grid">
                                <div class="edit-item">
                                    <label for="editRut">RUT <span class="required">*</span></label>
                                    <input type="text" id="editRut" name="rut" class="form-control-edit" maxlength="12" required>
                                    <div class="invalid-feedback" id="edit-rut-error"></div>
                                </div>
                                <div class="edit-item">
                                    <label for="editNombres">Nombres <span class="required">*</span></label>
                                    <input type="text" id="editNombres" name="nombres" class="form-control-edit" required>
                                    <div class="invalid-feedback" id="edit-nombres-error"></div>
                                </div>
                                <div class="edit-item">
                                    <label for="editApellidos">Apellidos <span class="required">*</span></label>
                                    <input type="text" id="editApellidos" name="apellidos" class="form-control-edit" required>
                                    <div class="invalid-feedback" id="edit-apellidos-error"></div>
                                </div>
                            </div>
                        </div>
                    
                        <!-- Información de Contacto -->
                        <div class="edit-section">
                            <h6><i class="fas fa-address-book"></i> Información de Contacto</h6>
                            <div class="edit-grid">
                                <div class="edit-item">
                                    <label for="editCorreo">Correo Electrónico <span class="required">*</span></label>
                                    <input type="email" id="editCorreo" name="correo" class="form-control-edit" required>
                                    <div class="invalid-feedback" id="edit-correo-error"></div>
                                </div>
                                <div class="edit-item">
                                    <label for="editTelefono">Teléfono</label>
                                    <input type="tel" id="editTelefono" name="telefono" class="form-control-edit" maxlength="16" value="+56 9 ">
                                    <div class="invalid-feedback" id="edit-telefono-error"></div>
                                </div>
                            </div>
                        </div>
                    
                        <!-- Información del Sistema -->
                        <div class="edit-section">
                            <h6><i class="fas fa-cogs"></i> Información del Sistema</h6>
                            <div class="edit-grid">
                                <div class="edit-item">
                                    <label for="editRolSelect">Rol <span class="required">*</span></label>
                                    <select id="editRolSelect" name="rol" class="form-control-edit" required>
                                        <option value="usuario">Usuario</option>
                                        <option value="admin">Administrador</option>
                                    </select>
                                </div>
                                <div class="edit-item">
                                    <label for="editEstadoSelect">Estado <span class="required">*</span></label>
                                    <select id="editEstadoSelect" name="estado" class="form-control-edit" required>
                                        <option value="active">Activo</option>
                                        <option value="inactive">Inactivo</option>
                                        <option value="pending">Pendiente</option>
                                    </select>
                                </div>
                                <div class="edit-item">
                                    <label for="editFuncionInput">Función</label>
                                    <input type="text" id="editFuncionInput" name="funcion" class="form-control-edit">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="edit-modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeEditModal()">
                        <i class="fas fa-times me-1"></i>Cancelar
                    </button>
                    <button type="submit" class="btn-success">
                        <i class="fas fa-save me-1"></i>Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/lista_usuarios.js' %}"></script>
<script>
    // Variables globales
    window.currentUserData = null;

    // Función para resetear los filtros
    function resetFilters() {
        document.querySelector('.search-input').value = '';
        document.querySelector('.filter-rol').value = '';
        document.querySelector('.filter-estado').value = '';
        
        // Disparar el evento para actualizar la tabla
        document.querySelector('.search-input').dispatchEvent(new Event('input'));
    }
    
    // Función para mostrar el modal de eliminación
    function showDeleteModal(button) {
        const userId = button.getAttribute('data-id');
        const userName = button.getAttribute('data-nombre');
        const userRut = button.getAttribute('data-rut');
        
        // Actualizar contenido del modal
        document.getElementById('userName').textContent = userName;
        document.getElementById('userRut').textContent = userRut;
        
        // Usar la URL correcta de Django
        document.getElementById('deleteForm').action = "{% url 'usuarios:eliminar_usuario' 0 %}".replace('0', userId);
        
        // Mostrar modal
        document.getElementById('deleteModal').style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }
    
    // Función para cerrar el modal de eliminación
    function closeDeleteModal() {
        document.getElementById('deleteModal').style.display = 'none';
        document.body.style.overflow = 'auto';
    }
    
    // Función para mostrar el modal de detalles
    function showDetailModal(button) {
        console.log('showDetailModal llamada'); // Debug
        
        const userData = {
            id: button.getAttribute('data-id'),
            rut: button.getAttribute('data-rut'),
            nombres: button.getAttribute('data-nombres'),
            apellidos: button.getAttribute('data-apellidos'),
            correo: button.getAttribute('data-correo'),
            telefono: button.getAttribute('data-telefono') || '',
            rol: button.getAttribute('data-rol'),
            estado: button.getAttribute('data-estado'),
            funcion: button.getAttribute('data-funcion') || '',
            fecha: button.getAttribute('data-fecha')
        };
        
        console.log('Datos del usuario:', userData); // Debug
        
        // Guardar datos globalmente
        window.currentUserData = userData;
        
        // Llenar los datos en el modal de detalles
        document.getElementById('detailUserName').textContent = `${userData.nombres} ${userData.apellidos}`;
        document.getElementById('detailRut').textContent = userData.rut || '-';
        document.getElementById('detailNombres').textContent = userData.nombres || '-';
        document.getElementById('detailApellidos').textContent = userData.apellidos || '-';
        document.getElementById('detailCorreo').textContent = userData.correo || '-';
        document.getElementById('detailTelefono').textContent = userData.telefono || '-';
        document.getElementById('detailFuncion').textContent = userData.funcion || '-';
        document.getElementById('detailFechaRegistro').textContent = userData.fecha || '-';
        
        // Configurar el rol
        const roleElement = document.getElementById('detailUserRole');
        const stateElement = document.getElementById('detailEstado');
        
        // Configurar badge del rol
        if (userData.rol === 'admin') {
            roleElement.className = 'role-badge role-admin';
            roleElement.innerHTML = '<i class="fas fa-user-shield"></i> Administrador';
        } else if (userData.rol === 'usuario') {
            roleElement.className = 'role-badge role-staff';
            roleElement.innerHTML = '<i class="fas fa-user"></i> Usuario';
        }
        
        // Configurar badge del estado
        if (userData.estado === 'active') {
            stateElement.className = 'status-badge status-active';
            stateElement.textContent = 'Activo';
        } else if (userData.estado === 'inactive') {
            stateElement.className = 'status-badge status-inactive';
            stateElement.textContent = 'Inactivo';
        } else {
            stateElement.className = 'status-badge status-pending';
            stateElement.textContent = 'Pendiente';
        }
        
        // Mostrar modal con animación
        const modal = document.getElementById('detailModal');
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        
        // Trigger de la animación de entrada
        setTimeout(() => {
            modal.classList.add('show');
        }, 10);
    }
    
    // Función para cerrar el modal de detalles
    function closeDetailModal() {
        const modal = document.getElementById('detailModal');
        
        modal.classList.remove('show');
        
        setTimeout(() => {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }, 300);
    }
    
    // Función para redireccionar al formulario de edición
    function redirectToEdit() {
        console.log('redirectToEdit llamada'); // Debug
        console.log('currentUserData:', window.currentUserData); // Debug
        
        if (!window.currentUserData || !window.currentUserData.id) {
            alert('No hay datos de usuario disponibles');
            return;
        }
        
        const userId = window.currentUserData.id;
        console.log('Redirigiendo a editar usuario ID:', userId); // Debug
        
        // Cerrar el modal de detalles
        closeDetailModal();
        
        // Redireccionar a la página de edición
        const editUrl = "{% url 'usuarios:editar_usuario' 999 %}".replace('999', userId);
        console.log('URL de edición:', editUrl); // Debug
        
        window.location.href = editUrl;
    }
    
    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM cargado'); // Debug
        
        const deleteModal = document.getElementById('deleteModal');
        const detailModal = document.getElementById('detailModal');
        
        // Cerrar modales al hacer clic fuera
        if (deleteModal) {
            deleteModal.addEventListener('click', function(e) {
                if (e.target === deleteModal) {
                    closeDeleteModal();
                }
            });
        }
        
        if (detailModal) {
            detailModal.addEventListener('click', function(e) {
                if (e.target === detailModal) {
                    closeDetailModal();
                }
            });
        }
        
        // Cerrar modales con tecla Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                if (deleteModal && deleteModal.style.display === 'flex') {
                    closeDeleteModal();
                }
                if (detailModal && detailModal.classList.contains('show')) {
                    closeDetailModal();
                }
            }
        });
        
        // Verificar que el botón de editar existe
        const editBtn = document.getElementById('editBtn');
        if (editBtn) {
            console.log('Botón de editar encontrado'); // Debug
        } else {
            console.log('Botón de editar NO encontrado'); // Debug
        }
    });

    // Función para cerrar alertas
    function closeAlert(button) {
        const alert = button.closest('.custom-alert');
        alert.classList.add('fade-out');
        setTimeout(() => {
            if (alert.parentNode) {
                alert.remove();
            }
        }, 300);
    }

    // Función para auto-cerrar una alerta específica
    function autoCloseAlert(alertElement, delay = 2000) {
        setTimeout(() => {
            if (alertElement && alertElement.parentNode) {
                const closeButton = alertElement.querySelector('.alert-close');
                if (closeButton) {
                    closeAlert(closeButton);
                }
            }
        }, delay);
    }

    // Auto-cerrar alertas cuando se carga la página
    document.addEventListener('DOMContentLoaded', function() {
        // Auto-cerrar todas las alertas después de 2 segundos
        const allAlerts = document.querySelectorAll('.custom-alert');
        allAlerts.forEach(alert => {
            autoCloseAlert(alert, 2000);
        });
    });
</script>
{% endblock %}
