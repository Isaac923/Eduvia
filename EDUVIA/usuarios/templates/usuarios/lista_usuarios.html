{% extends 'base.html' %}
{% load static %}

{% block title %}Listado de Usuarios - EDUVIA{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/lista_usuarios.css' %}">
{% endblock %}

{% block content %}
<div class="content-wrapper">
    <div class="user-list-container">
        <!-- Encabezado de la página -->
        <div class="page-header">
            <h2>Listado de Usuarios</h2>
            <a href="{% url 'usuarios:nuevo_usuario' %}" class="btn-eduvia btn-primary">
                <i class="fas fa-plus-circle"></i> Nuevo Usuario
            </a>
        </div>
        
        <!-- Contenedor para alertas dinámicas -->
        <div id="alertContainer"></div>

        <!-- Alertas de Django Messages -->
        {% if messages %}
            {% for message in messages %}
                <div class="custom-alert alert-{{ message.tags }}" id="djangoAlert">
                    <div class="alert-content">
                        {% if message.tags == 'success' %}
                            <i class="fas fa-check-circle alert-icon"></i>
                        {% elif message.tags == 'error' %}
                            <i class="fas fa-exclamation-circle alert-icon"></i>
                        {% endif %}
                        <span class="alert-message">{{ message }}</span>
                    </div>
                    <button type="button" class="alert-close" onclick="closeAlert(this)">×</button>
                </div>
            {% endfor %}
        {% endif %}
        
        {% if usuarios %}
        <!-- Búsqueda y filtros -->
        <div class="search-filter-container">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" class="form-control search-input" placeholder="Buscar por RUT, nombre o apellido...">
            </div>
            <div class="filter-group">
                <select id="filterRol" class="form-select filter-dropdown filter-rol">
                    <option value="">Todos los roles</option>
                    <option value="admin">Administrador</option>
                    <option value="teacher">Profesor</option>
                    <option value="usuario">Usuario</option>
                </select>
                <select id="filterEstado" class="form-select filter-dropdown filter-estado">
                    <option value="">Todos los estados</option>
                    <option value="active">Activo</option>
                    <option value="inactive">Inactivo</option>
                    <option value="pending">Pendiente</option>
                </select>
            </div>
        </div>
        {% endif %}
        
        <!-- Contenedor de tabla con scroll interno -->
        <div class="table-container">
            <table class="user-table">
                <thead>
                    <tr>
                        <th>RUT</th>
                        <th>Nombres</th>
                        <th>Apellidos</th>
                        <th>Rol</th>
                        <th>Función</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    {% for usuario in usuarios %}
                    <tr class="user-row" 
                        data-rut="{{ usuario.rut|lower }}"
                        data-nombre="{{ usuario.nombres|lower }} {{ usuario.apellidos|lower }}"
                        data-rol="{{ usuario.rol }}"
                        data-estado="{{ usuario.estado }}">
                        <td>{{ usuario.rut }}</td>
                        <td>{{ usuario.nombres }}</td>
                        <td>{{ usuario.apellidos }}</td>
                        <td data-rol="{{ usuario.rol }}">
                            {% if usuario.rol == 'admin' %}
                                <span class="role-badge role-admin">
                                    <i class="fas fa-user-shield"></i> Administrador
                                </span>
                            {% elif usuario.rol == 'teacher' %}
                                <span class="role-badge role-teacher">
                                    <i class="fas fa-chalkboard-teacher"></i> Profesor
                                </span>
                            {% elif usuario.rol == 'student' %}
                                <span class="role-badge role-student">
                                    <i class="fas fa-user-graduate"></i> Estudiante
                                </span>
                            {% else %}
                                <span class="role-badge role-staff">
                                    <i class="fas fa-user"></i> Personal
                                </span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="function-badge">{{ usuario.funcion|default:"Sin función" }}</span>
                        </td>
                        <td data-estado="{{ usuario.estado }}">
                            {% if usuario.estado == 'active' %}
                                <span class="status-badge status-active">Activo</span>
                            {% elif usuario.estado == 'inactive' %}
                                <span class="status-badge status-inactive">Inactivo</span>
                            {% else %}
                                <span class="status-badge status-pending">Pendiente</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button type="button" class="btn-action btn-view" 
                                        data-id="{{ usuario.id }}"
                                        data-rut="{{ usuario.rut|default:'' }}"
                                        data-nombres="{{ usuario.nombres|default:'' }}"
                                        data-apellidos="{{ usuario.apellidos|default:'' }}"
                                        data-correo="{{ usuario.correo|default:'' }}"
                                        data-telefono="{{ usuario.telefono|default:'' }}"
                                        data-rol="{{ usuario.rol|default:'usuario' }}"
                                        data-estado="{{ usuario.estado|default:'inactive' }}"
                                        data-funcion="{{ usuario.funcion|default:'' }}"
                                        data-fecha="{{ usuario.fecha_creacion|date:'d/m/Y H:i'|default:'-' }}"
                                        onclick="showDetailModal(this)"
                                        title="Ver detalles">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button type="button" class="btn-action btn-delete" 
                                        data-id="{{ usuario.id }}" 
                                        data-nombre="{{ usuario.nombres }} {{ usuario.apellidos }}"
                                        data-rut="{{ usuario.rut }}"
                                        onclick="showDeleteModal(this)"
                                        title="Eliminar usuario">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <div class="empty-state">
                                <i class="fas fa-users fa-3x text-muted mb-3"></i>
                                <p>No se encontraron usuarios.</p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Mensaje cuando no hay resultados de búsqueda -->
        <div id="empty-results" style="display: none;" class="empty-results">
            <div class="empty-state">
                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                <p>No se encontraron usuarios que coincidan con los criterios de búsqueda.</p>
                <button class="btn btn-outline-primary mt-2" onclick="resetFilters()">
                    <i class="fas fa-undo"></i> Limpiar filtros
                </button>
            </div>
        </div>

        <!-- Paginador EDUVIA -->
        <div class="pagination-container" id="paginationContainer">
            <div class="pagination-info">
                <span>Mostrando <strong id="showingStart">1</strong> - <strong id="showingEnd">4</strong> de <strong id="totalItems">{{ usuarios.count }}</strong> usuarios</span>
            </div>
            <div class="pagination-controls">
                <button class="pagination-btn" id="firstPage" title="Primera página">
                    <i class="fas fa-angle-double-left"></i>
                </button>
                <button class="pagination-btn" id="prevPage" title="Página anterior">
                    <i class="fas fa-angle-left"></i>
                </button>
                <div class="pagination-numbers" id="paginationNumbers">
                    <!-- Los números se generan dinámicamente -->
                </div>
                <button class="pagination-btn" id="nextPage" title="Página siguiente">
                    <i class="fas fa-angle-right"></i>
                </button>
                <button class="pagination-btn" id="lastPage" title="Última página">
                    <i class="fas fa-angle-double-right"></i>
                </button>
            </div>
            <div class="pagination-size">
                <label for="pageSize">Mostrar:</label>
                <select id="pageSize" class="page-size-select">
                    <option value="4">4</option>
                    <option value="8">8</option>
                    <option value="12">12</option>
                    <option value="20">20</option>
                    <option value="50">50</option>
                </select>
                <span>por página</span>
            </div>
        </div>
    </div>

    <!-- Modal de confirmación para eliminar usuario -->
    <div class="delete-alert-modal" id="deleteModal" style="display: none;">
        <div class="delete-alert-content">
            <div class="delete-alert-header">
                <h5><i class="fas fa-exclamation-triangle me-2"></i>Confirmar eliminación</h5>
                <button type="button" class="delete-alert-close" onclick="closeDeleteModal()">×</button>
            </div>
            <div class="delete-alert-body">
                <div class="text-center mb-3">
                    <i class="fas fa-user-times fa-3x text-danger mb-3"></i>
                    <p>¿Está seguro que desea eliminar al usuario?</p>
                    <p class="fw-bold" id="userName">Nombre del Usuario</p>
                    <p><strong>RUT:</strong> <span id="userRut"></span></p>
                </div>
                <div class="delete-alert-warning">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <span>Esta acción no se puede deshacer. Todos los datos del usuario serán eliminados permanentemente.</span>
                </div>
            </div>
            <div class="delete-alert-footer">
                <button type="button" class="btn-cancel" onclick="closeDeleteModal()">
                    <i class="fas fa-times me-1"></i>Cancelar
                </button>
                <form id="deleteForm" method="POST" action="" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn-delete-confirm">
                        <i class="fas fa-trash-alt me-1"></i>Eliminar Usuario
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de detalles del usuario -->
    <div class="detail-modal" id="detailModal" style="display: none;">
        <div class="detail-modal-content">
            <div class="detail-modal-header">
                <h5 id="modalTitle"><i class="fas fa-user-circle me-2"></i>Detalles del Usuario</h5>
                <button type="button" class="detail-modal-close" onclick="closeDetailModal()">×</button>
            </div>
            <div class="detail-modal-body">
                <div class="user-avatar">
                    <i class="fas fa-user-circle fa-3x text-primary"></i>
                    <h4 id="detailUserName">Nombre del Usuario</h4>
                    <span id="detailUserRole" class="role-badge">Rol</span>
                </div>
            
                <div id="readOnlyView" class="detail-sections">
                    <div class="detail-section">
                        <h6><i class="fas fa-user"></i> Información Personal</h6>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <label>RUT:</label>
                                <span id="detailRut">-</span>
                            </div>
                            <div class="detail-item">
                                <label>Nombres:</label>
                                <span id="detailNombres">-</span>
                            </div>
                            <div class="detail-item">
                                <label>Apellidos:</label>
                                <span id="detailApellidos">-</span>
                            </div>
                        </div>
                    </div>
                
                    <div class="detail-section">
                        <h6><i class="fas fa-address-book"></i> Información de Contacto</h6>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <label>Correo Electrónico:</label>
                                <span id="detailCorreo">-</span>
                            </div>
                            <div class="detail-item">
                                <label>Teléfono:</label>
                                <span id="detailTelefono">-</span>
                            </div>
                        </div>
                    </div>
                
                    <div class="detail-section">
                        <h6><i class="fas fa-cogs"></i> Información del Sistema</h6>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <label>Estado:</label>
                                <span id="detailEstado" class="status-badge">-</span>
                            </div>
                            <div class="detail-item">
                                <label>Función:</label>
                                <span id="detailFuncion">-</span>
                            </div>
                            <div class="detail-item">
                                <label>Fecha de Registro:</label>
                                <span id="detailFechaRegistro">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="detail-modal-footer">
                <button type="button" class="btn-secondary" onclick="closeDetailModal()">
                    <i class="fas fa-times me-1"></i>Cerrar
                </button>
                <button type="button" class="btn-primary" id="editBtn" onclick="redirectToEdit()">
                    <i class="fas fa-edit me-1"></i>Editar Usuario
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block extra_js %}
<script src="{% static 'js/lista_usuarios.js' %}"></script>
<script>
    // Variables globales
    window.currentUserData = null;

    // Función para resetear los filtros
    function resetFilters() {
        resetFiltersWithPagination();
    }
    
    // Función para mostrar el modal de eliminación
    function showDeleteModal(button) {
        const userId = button.getAttribute('data-id');
        const userName = button.getAttribute('data-nombre');
        const userRut = button.getAttribute('data-rut');
        
        // Actualizar contenido del modal
        document.getElementById('userName').textContent = userName;
        document.getElementById('userRut').textContent = userRut;
        
        // Usar la URL correcta de Django
        document.getElementById('deleteForm').action = "{% url 'usuarios:eliminar_usuario' 0 %}".replace('0', userId);
        
        // Mostrar modal
        document.getElementById('deleteModal').style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }
    
    // Función para cerrar el modal de eliminación
    function closeDeleteModal() {
        document.getElementById('deleteModal').style.display = 'none';
        document.body.style.overflow = 'auto';
    }
    
    // Función para mostrar el modal de detalles
    function showDetailModal(button) {
        console.log('showDetailModal llamada'); // Debug
        
        const userData = {
            id: button.getAttribute('data-id'),
            rut: button.getAttribute('data-rut'),
            nombres: button.getAttribute('data-nombres'),
            apellidos: button.getAttribute('data-apellidos'),
            correo: button.getAttribute('data-correo'),
            telefono: button.getAttribute('data-telefono') || '',
            rol: button.getAttribute('data-rol'),
            estado: button.getAttribute('data-estado'),
            funcion: button.getAttribute('data-funcion') || '',
            fecha: button.getAttribute('data-fecha')
        };
        
        console.log('Datos del usuario:', userData); // Debug
        
        // Guardar datos globalmente
        window.currentUserData = userData;
        
        // Llenar los datos en el modal de detalles
        document.getElementById('detailUserName').textContent = `${userData.nombres} ${userData.apellidos}`;
        document.getElementById('detailRut').textContent = userData.rut || '-';
        document.getElementById('detailNombres').textContent = userData.nombres || '-';
        document.getElementById('detailApellidos').textContent = userData.apellidos || '-';
        document.getElementById('detailCorreo').textContent = userData.correo || '-';
        document.getElementById('detailTelefono').textContent = userData.telefono || '-';
        document.getElementById('detailFuncion').textContent = userData.funcion || '-';
        document.getElementById('detailFechaRegistro').textContent = userData.fecha || '-';
        
        // Configurar el rol
        const roleElement = document.getElementById('detailUserRole');
        const stateElement = document.getElementById('detailEstado');
        
        // Configurar badge del rol
        if (userData.rol === 'admin') {
            roleElement.className = 'role-badge role-admin';
            roleElement.innerHTML = '<i class="fas fa-user-shield"></i> Administrador';
        } else if (userData.rol === 'usuario') {
            roleElement.className = 'role-badge role-staff';
            roleElement.innerHTML = '<i class="fas fa-user"></i> Usuario';
        } else if (userData.rol === 'student') {
            roleElement.className = 'role-badge role-student';
            roleElement.innerHTML = '<i class="fas fa-user-graduate"></i> Estudiante';
        } else {
            roleElement.className = 'role-badge role-staff';
            roleElement.innerHTML = '<i class="fas fa-user"></i> Personal';
        }
        
        // Configurar badge del estado
        if (userData.estado === 'active') {
            stateElement.className = 'status-badge status-active';
            stateElement.textContent = 'Activo';
        } else if (userData.estado === 'inactive') {
            stateElement.className = 'status-badge status-inactive';
            stateElement.textContent = 'Inactivo';
        } else {
            stateElement.className = 'status-badge status-pending';
            stateElement.textContent = 'Pendiente';
        }
        
        // Mostrar modal con animación
        const modal = document.getElementById('detailModal');
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        
        // Trigger de la animación de entrada
        setTimeout(() => {
            modal.classList.add('show');
        }, 10);
    }
    
    // Función para cerrar el modal de detalles
    function closeDetailModal() {
        const modal = document.getElementById('detailModal');
        
        modal.classList.remove('show');
        
        setTimeout(() => {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }, 300);
    }
    
    // Función para redireccionar al formulario de edición
    function redirectToEdit() {
        if (!window.currentUserData || !window.currentUserData.id) {
            alert('No hay datos de usuario disponibles');
            return;
        }
        
        const userId = window.currentUserData.id;
        
        // Cerrar el modal de detalles
        closeDetailModal();
        
        // Redireccionar a la página de edición
        const editUrl = "{% url 'usuarios:editar_usuario' 999 %}".replace('999', userId);
        window.location.href = editUrl;
    }
    
    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
        const deleteModal = document.getElementById('deleteModal');
        const detailModal = document.getElementById('detailModal');
        
        // Cerrar modales al hacer clic fuera
        if (deleteModal) {
            deleteModal.addEventListener('click', function(e) {
                if (e.target === deleteModal) {
                    closeDeleteModal();
                }
            });
        }
        
        if (detailModal) {
            detailModal.addEventListener('click', function(e) {
                if (e.target === detailModal) {
                    closeDetailModal();
                }
            });
        }
        
        // Cerrar modales con tecla Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                if (deleteModal && deleteModal.style.display === 'flex') {
                    closeDeleteModal();
                }
                if (detailModal && detailModal.classList.contains('show')) {
                    closeDetailModal();
                }
            }
        });
    });

    // Función para cerrar alertas
    function closeAlert(button) {
        const alert = button.closest('.custom-alert');
        alert.classList.add('fade-out');
        setTimeout(() => {
            if (alert.parentNode) {
                alert.remove();
            }
        }, 300);
    }

    // Función para auto-cerrar una alerta específica
    function autoCloseAlert(alertElement, delay = 2000) {
        setTimeout(() => {
            if (alertElement && alertElement.parentNode) {
                const closeButton = alertElement.querySelector('.alert-close');
                if (closeButton) {
                    closeAlert(closeButton);
                }
            }
        }, delay);
    }

    // Auto-cerrar alertas cuando se carga la página
    document.addEventListener('DOMContentLoaded', function() {
        // Auto-cerrar todas las alertas después de 2 segundos
        const allAlerts = document.querySelectorAll('.custom-alert');
        allAlerts.forEach(alert => {
            autoCloseAlert(alert, 2000);
        });
    });

    // Variables de paginación - actualizadas
    let currentPage = 1;
    let itemsPerPage = 4;
    let totalItems = 0;
    let filteredItems = [];
    let allUserRows = [];

    // Función para inicializar paginación - MEJORADA
    function initializePagination() {
        // Obtener todas las filas de usuarios reales del DOM
        allUserRows = Array.from(document.querySelectorAll('.user-row'));
        totalItems = allUserRows.length;
        filteredItems = [...allUserRows]; // Copia del array
        
        console.log(`Paginador inicializado: ${totalItems} usuarios encontrados`);
        
        // Solo mostrar paginador si hay más de 4 usuarios
        const paginationContainer = document.getElementById('paginationContainer');
        if (totalItems <= 4) {
            if (paginationContainer) {
                paginationContainer.style.display = 'none';
            }
            // Mostrar todos los usuarios si son 4 o menos
            allUserRows.forEach(row => row.style.display = '');
            updateCounter(totalItems, totalItems);
            return;
        }
        
        // Mostrar paginador si hay más de 4 usuarios
        if (paginationContainer) {
            paginationContainer.style.display = 'flex';
        }
        
        // Event listeners para controles de paginación
        const firstPageBtn = document.getElementById('firstPage');
        const prevPageBtn = document.getElementById('prevPage');
        const nextPageBtn = document.getElementById('nextPage');
        const lastPageBtn = document.getElementById('lastPage');
        const pageSizeSelect = document.getElementById('pageSize');
        
        if (firstPageBtn) firstPageBtn.addEventListener('click', () => goToPage(1));
        if (prevPageBtn) prevPageBtn.addEventListener('click', () => goToPage(currentPage - 1));
        if (nextPageBtn) nextPageBtn.addEventListener('click', () => goToPage(currentPage + 1));
        if (lastPageBtn) lastPageBtn.addEventListener('click', () => goToPage(getTotalPages()));
        
        // Event listener para cambio de tamaño de página
        if (pageSizeSelect) {
            pageSizeSelect.addEventListener('change', function() {
                itemsPerPage = parseInt(this.value);
                currentPage = 1;
                updatePagination();
            });
        }
        
        // Inicializar primera página
        updatePagination();
    }

    // Función para obtener total de páginas - SIN CAMBIOS
    function getTotalPages() {
        return Math.ceil(filteredItems.length / itemsPerPage);
    }

    // Función para ir a una página específica - MEJORADA
    function goToPage(page) {
        const totalPages = getTotalPages();
        
        if (page < 1 || page > totalPages || totalPages === 0) return;
        
        currentPage = page;
        updatePagination();
        
        // Scroll suave al inicio de la tabla
        const tableContainer = document.getElementById('tableBodyScroll');
        if (tableContainer) {
            tableContainer.scrollTo({ top: 0, behavior: 'smooth' });
        }
    }

    // Función para actualizar la paginación - MEJORADA
    function updatePagination() {
        const totalPages = getTotalPages();
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        
        // Ocultar TODAS las filas de usuarios primero
        allUserRows.forEach(row => {
            row.style.display = 'none';
            row.classList.remove('fade-in-page');
        });
        
        // Mostrar solo las filas de la página actual de los elementos filtrados
        const currentPageItems = filteredItems.slice(startIndex, endIndex);
        currentPageItems.forEach((row, index) => {
            row.style.display = '';
            // Animación escalonada
            setTimeout(() => {
                row.style.animationDelay = `${index * 0.05}s`;
                row.classList.add('fade-in-page');
            }, 50);
        });
        
        // Actualizar información de paginación
        updatePaginationInfo();
        updatePaginationControls();
        updatePaginationNumbers();
        
        // Actualizar contador con los usuarios visibles en esta página
        const visibleCount = currentPageItems.length;
        updateCounter(visibleCount, filteredItems.length);
        
        // Verificar indicador de scroll
        setTimeout(checkScrollIndicator, 100);
        
        console.log(`Página ${currentPage}: Mostrando ${visibleCount} de ${filteredItems.length} usuarios`);
    }

    // Función para actualizar información de paginación - SIN CAMBIOS
    function updatePaginationInfo() {
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = Math.min(startIndex + itemsPerPage, filteredItems.length);
        
        const showingStartEl = document.getElementById('showingStart');
        const showingEndEl = document.getElementById('showingEnd');
        const totalItemsEl = document.getElementById('totalItems');
        
        if (showingStartEl) showingStartEl.textContent = filteredItems.length > 0 ? startIndex + 1 : 0;
        if (showingEndEl) showingEndEl.textContent = endIndex;
        if (totalItemsEl) totalItemsEl.textContent = filteredItems.length;
    }

    // Función para actualizar controles de paginación - MEJORADA
    function updatePaginationControls() {
        const totalPages = getTotalPages();
        
        const firstPageBtn = document.getElementById('firstPage');
        const prevPageBtn = document.getElementById('prevPage');
        const nextPageBtn = document.getElementById('nextPage');
        const lastPageBtn = document.getElementById('lastPage');
        
        if (firstPageBtn) firstPageBtn.disabled = currentPage === 1 || totalPages === 0;
        if (prevPageBtn) prevPageBtn.disabled = currentPage === 1 || totalPages === 0;
        if (nextPageBtn) nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;
        if (lastPageBtn) lastPageBtn.disabled = currentPage === totalPages || totalPages === 0;
    }

    // Función para actualizar números de paginación
    function updatePaginationNumbers() {
        const totalPages = getTotalPages();
        const numbersContainer = document.getElementById('paginationNumbers');
        numbersContainer.innerHTML = '';
        
        if (totalPages <= 1) return;
        
        // Calcular rango de páginas a mostrar
        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, currentPage + 2);
        
        // Ajustar si estamos cerca del inicio o final
        if (currentPage <= 3) {
            endPage = Math.min(5, totalPages);
        }
        if (currentPage >= totalPages - 2) {
            startPage = Math.max(1, totalPages - 4);
        }
        
        // Agregar primera página si no está en el rango
        if (startPage > 1) {
            addPageNumber(1);
            if (startPage > 2) {
                addEllipsis();
            }
        }
        
        // Agregar páginas en el rango
        for (let i = startPage; i <= endPage; i++) {
            addPageNumber(i);
        }
        
        // Agregar última página si no está en el rango
        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                addEllipsis();
            }
            addPageNumber(totalPages);
        }
    }

    // Función para agregar número de página
    function addPageNumber(pageNum) {
        const pageButton = document.createElement('button');
        pageButton.className = `pagination-number ${pageNum === currentPage ? 'active' : ''}`;
        pageButton.innerHTML = `<span>${pageNum}</span>`;
        pageButton.addEventListener('click', () => goToPage(pageNum));
        
        document.getElementById('paginationNumbers').appendChild(pageButton);
    }

    // Función para agregar puntos suspensivos
    function addEllipsis() {
        const ellipsis = document.createElement('div');
        ellipsis.className = 'pagination-ellipsis';
        ellipsis.textContent = '...';
        document.getElementById('paginationNumbers').appendChild(ellipsis);
    }

    // Función de filtrado actualizada para trabajar con paginación - MEJORADA
    function filterUsersWithPagination() {
        const searchInput = document.getElementById('searchInput');
        const filterRol = document.getElementById('filterRol');
        const filterEstado = document.getElementById('filterEstado');
        
        const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
        const rolFilter = filterRol ? filterRol.value : '';
        const estadoFilter = filterEstado ? filterEstado.value : '';
        
        // Filtrar desde todas las filas de usuarios
        filteredItems = allUserRows.filter(row => {
            const rutNombre = row.getAttribute('data-nombre') || '';
            const rut = row.getAttribute('data-rut') || '';
            const rol = row.getAttribute('data-rol') || '';
            const estado = row.getAttribute('data-estado') || '';
            
            const matchesSearch = !searchTerm || 
                                rutNombre.includes(searchTerm) || 
                                rut.includes(searchTerm);
            const matchesRol = !rolFilter || rol === rolFilter;
            const matchesEstado = !estadoFilter || estado === estadoFilter;
            
            return matchesSearch && matchesRol && matchesEstado;
        });
        
        // Resetear a la primera página cuando se filtra
        currentPage = 1;
        
        // Mostrar/ocultar paginador según la cantidad de resultados
        const paginationContainer = document.getElementById('paginationContainer');
        const emptyResults = document.getElementById('empty-results');
        
        if (filteredItems.length === 0 && allUserRows.length > 0) {
            // No hay resultados de búsqueda
            if (emptyResults) emptyResults.style.display = 'block';
            if (paginationContainer) paginationContainer.style.display = 'none';
            updateCounter(0, allUserRows.length);
        } else if (filteredItems.length <= 4) {
            // 4 o menos resultados - no necesita paginador
            if (emptyResults) emptyResults.style.display = 'none';
            if (paginationContainer) paginationContainer.style.display = 'none';
            
            // Mostrar todos los resultados filtrados
            allUserRows.forEach(row => row.style.display = 'none');
            filteredItems.forEach(row => row.style.display = '');
            updateCounter(filteredItems.length, filteredItems.length);
        } else {
            // Más de 4 resultados - mostrar paginador
            if (emptyResults) emptyResults.style.display = 'none';
            if (paginationContainer) paginationContainer.style.display = 'flex';
            updatePagination();
        }
        
        console.log(`Filtro aplicado: ${filteredItems.length} usuarios encontrados de ${allUserRows.length} totales`);
    }

    // Función para resetear filtros actualizada - MEJORADA
    function resetFiltersWithPagination() {
        const searchInput = document.getElementById('searchInput');
        const filterRol = document.getElementById('filterRol');
        const filterEstado = document.getElementById('filterEstado');
        
        if (searchInput) searchInput.value = '';
        if (filterRol) filterRol.value = '';
        if (filterEstado) filterEstado.value = '';
        
        // Restaurar todos los usuarios
        filteredItems = [...allUserRows];
        currentPage = 1;
        
        const emptyResults = document.getElementById('empty-results');
        const paginationContainer = document.getElementById('paginationContainer');
        
        if (emptyResults) emptyResults.style.display = 'none';
        
        // Mostrar paginador solo si hay más de 4 usuarios
        if (filteredItems.length > 4) {
            if (paginationContainer) paginationContainer.style.display = 'flex';
            updatePagination();
        } else {
            if (paginationContainer) paginationContainer.style.display = 'none';
            allUserRows.forEach(row => row.style.display = '');
            updateCounter(filteredItems.length, filteredItems.length);
        }
        
        console.log('Filtros reseteados');
    }

    // Función para actualizar contador - MEJORADA
    function updateCounter(visible, total) {
        const counterNumber = document.querySelector('.counter-number');
        if (counterNumber) {
            counterNumber.textContent = visible;
            
            // Cambiar color si hay filtros activos o paginación
            if (visible < allUserRows.length) {
                counterNumber.style.background = 'rgba(245, 158, 11, 0.9)';
            } else {
                counterNumber.style.background = 'rgba(255, 255, 255, 0.2)';
            }
        }
    }

    // Actualizar las funciones existentes para usar las nuevas versiones
    function filterUsers() {
        filterUsersWithPagination();
    }

    function resetFilters() {
        resetFiltersWithPagination();
    }

    // Agregar CSS para animación de página
    const pageAnimationCSS = `
        .fade-in-page {
            animation: fadeInPage 0.4s ease-out both;
        }
        
        @keyframes fadeInPage {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    `;

    // Agregar el CSS al head
    const style = document.createElement('style');
    style.textContent = pageAnimationCSS;
    document.head.appendChild(style);

    // Actualizar el event listener del DOMContentLoaded para incluir paginación
    document.addEventListener('DOMContentLoaded', function() {
        // ... tu código existente ...
        
        // Agregar esta línea
        initializePagination();
        
        // Actualizar los event listeners de filtros para usar la nueva función
        if (searchInput) {
            searchInput.addEventListener('input', debounce(filterUsersWithPagination, 300));
        }
        
        if (filterRol) {
            filterRol.addEventListener('change', filterUsersWithPagination);
        }
        
        if (filterEstado) {
            filterEstado.addEventListener('change', filterUsersWithPagination);
        }
        
        // ... resto de tu código existente ...
    });
</script>
{% endblock %}
