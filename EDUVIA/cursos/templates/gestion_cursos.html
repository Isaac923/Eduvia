{% extends "base.html" %}
{% block title %}Gestión de Cursos{% endblock %}
{% block content %}
<div class="container mt-4">
    <div class="row mb-3">
        <div class="col-md-6">
            <h2 style="color: #303f9f;">Gestión de Cursos</h2>
        </div>
        <div class="col-md-6 text-end">
            <a href="{% url 'cursos:crear_curso' %}" class="btn" style="background-color: #26a69a; color: white;">
                <i class="fas fa-plus"></i> Nuevo Curso
            </a>
        </div>
    </div>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}

    <!-- Filtros de búsqueda -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <form method="get" class="row g-2">
                <div class="col-md-6">
                    <div class="input-group">
                        <label class="input-group-text" for="nivelFilter" style="background-color: #5c6bc0; color: white;">Nivel</label>
                        <select class="form-select" id="nivelFilter" name="nivel" onchange="this.form.submit()">
                            <option value="todos" {% if nivel_filter == 'todos' %}selected{% endif %}>Todos los niveles</option>
                            <option value="1" {% if nivel_filter == '1' %}selected{% endif %}>Nivel 1</option>
                            <option value="2" {% if nivel_filter == '2' %}selected{% endif %}>Nivel 2</option>
                            <option value="3" {% if nivel_filter == '3' %}selected{% endif %}>Nivel 3</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="input-group">
                        <label class="input-group-text" for="jornadaFilter" style="background-color: #5c6bc0; color: white;">Jornada</label>
                        <select class="form-select" id="jornadaFilter" name="jornada" onchange="this.form.submit()">
                            <option value="todos" {% if jornada_filter == 'todos' %}selected{% endif %}>Todas las jornadas</option>
                            <option value="a" {% if jornada_filter == 'a' %}selected{% endif %}>Diurna (A)</option>
                            <option value="b" {% if jornada_filter == 'b' %}selected{% endif %}>Vespertina (B)</option>
                        </select>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Cards de cursos -->
    <div class="row mb-5">
        {% for curso in cursos %}
        <div class="col-md-4 mb-4">
            <div class="card h-100 shadow-sm curso-card" data-curso-id="{{ curso.id }}">
                <div class="card-header d-flex justify-content-between align-items-center" style="background-color: #5c6bc0; color: white;">
                    <h5 class="mb-0 nivel-curso">{{ curso.nivel }}° <span class="letra-curso">{{ curso.letra|upper }}</span></h5>
                    <span class="badge {% if curso.letra == 'a' %}bg-warning{% else %}bg-info{% endif %} jornada-curso">
                        {% if curso.letra == 'a' %}Diurno{% else %}Vespertino{% endif %}
                    </span>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6 class="fw-bold text-muted"><i class="fas fa-user-graduate me-2"></i>Alumnos:</h6>
                        <p>{{ curso.alumnos.count }} alumnos matriculados</p>
                    </div>
                </div>
                <div class="card-footer bg-transparent">
                    <div class="d-flex justify-content-between">
                        <button type="button" class="btn btn-sm ver-detalles-btn" style="background-color: #5c6bc0; color: white;" 
                                data-bs-toggle="modal" data-bs-target="#cursoDetallesModal" data-curso-id="{{ curso.id }}">
                            <i class="fas fa-eye me-1"></i> Ver Detalles
                        </button>
                        <a href="{% url 'cursos:editar_curso' id=curso.id %}" class="btn btn-sm" style="background-color: #26a69a; color: white;">
                            <i class="fas fa-edit me-1"></i> Editar
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body text-center py-5">
                    <i class="fas fa-school fa-4x mb-3" style="color: #78909c;"></i>
                    <h4 style="color: #78909c;">No hay cursos registrados</h4>
                    <p class="text-muted">Puedes crear un nuevo curso haciendo clic en el botón "Nuevo Curso".</p>
                    <a href="{% url 'cursos:crear_curso' %}" class="btn mt-3" style="background-color: #26a69a; color: white;">
                        <i class="fas fa-plus"></i> Crear Primer Curso
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    <div class="mb-5"></div>
</div>

<!-- Modal para ver detalles del curso -->
<div class="modal fade" id="cursoDetallesModal" tabindex="-1" aria-labelledby="cursoDetallesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background-color: #5c6bc0; color: white;">
                <h5 class="modal-title" id="cursoDetallesModalLabel">Detalles del Curso</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="background-color: white;"></button>
            </div>
            <div class="modal-body">
                <div id="modal-loading" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-2">Cargando detalles del curso...</p>
                </div>
                <div id="modal-content" style="display: none;">
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="card h-100">
                                <div class="card-header" style="background-color: #5c6bc0; color: white;">
                                    <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Información del Curso</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <h6 class="fw-bold text-muted">Nivel:</h6>
                                        <p id="modal-nivel"></p>
                                    </div>
                                    <div class="mb-3">
                                        <h6 class="fw-bold text-muted">Jornada:</h6>
                                        <p>
                                            <span id="modal-jornada"></span>
                                            <span id="modal-jornada-badge" class="badge"></span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card mb-3">
                        <div class="card-header" style="background-color: #5c6bc0; color: white;">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0"><i class="fas fa-user-graduate me-2"></i>Alumnos Matriculados</h6>
                                <span class="badge bg-primary" id="modal-total-alumnos">0 alumnos</span>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="alumnos-table-container">
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover">
                                        <thead>
                                            <tr>
                                                <th>Nombre</th>
                                                <th></th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="modal-alumnos-lista">
                                            <!-- Aquí se cargarán los alumnos dinámicamente -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div id="no-alumnos-message" style="display: none;">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    No hay alumnos matriculados en este curso.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="modal-error" class="alert alert-danger" style="display: none;">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <span id="error-message">Error al cargar los detalles del curso.</span>
                </div>
            </div>
            <div class="modal-footer">
                <div class="d-flex justify-content-between w-100">
                    <div>
                        <button type="button" class="btn btn-danger" id="eliminar-curso-btn">
                            <i class="fas fa-trash-alt me-1"></i> Eliminar Curso
                        </button>
                    </div>
                    <div>
                        <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cerrar</button>
                        <a href="#" id="editar-curso-link" class="btn" style="background-color: #26a69a; color: white;">
                            <i class="fas fa-edit me-1"></i> Editar Curso
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmación para eliminar curso -->
<div class="modal fade" id="confirmarEliminarModal" tabindex="-1" aria-labelledby="confirmarEliminarModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="confirmarEliminarModalLabel">Confirmar Eliminación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="background-color: white;"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <i class="fas fa-exclamation-triangle fa-4x text-warning mb-3"></i>
                    <h5>¿Estás seguro de que deseas eliminar este curso?</h5>
                    <p class="text-danger">Esta acción no se puede deshacer y eliminará toda la información asociada al curso.</p>
                </div>
                <div class="alert alert-warning">
                    <strong>Curso a eliminar:</strong> <span id="curso-a-eliminar"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form id="form-eliminar-curso" method="post" action="">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash-alt me-1"></i> Eliminar Definitivamente
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal para detalles del alumno -->
<div class="modal fade" id="alumnoDetallesModal" tabindex="-1" aria-labelledby="alumnoDetallesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background-color: #5c6bc0; color: white;">
                <h5 class="modal-title" id="alumnoDetallesModalLabel">Detalles del Alumno</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="background-color: white;"></button>
            </div>
            <div class="modal-body">
                <div id="alumno-modal-loading" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-2">Cargando detalles del alumno...</p>
                </div>
                
                <div id="alumno-modal-content" style="display: none;">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header" style="background-color: #5c6bc0; color: white;">
                                    <h6 class="mb-0"><i class="fas fa-user-graduate me-2"></i>Información Personal</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <h6 class="fw-bold text-muted">Nombre Completo:</h6>
                                        <p id="alumno-nombre"></p>
                                    </div>
                                    <div class="mb-3">
                                        <h6 class="fw-bold text-muted">RUT:</h6>
                                        <p id="alumno-rut"></p>
                                    </div>
                                    <div class="mb-3">
                                        <h6 class="fw-bold text-muted">Fecha de Nacimiento:</h6>
                                        <p id="alumno-fecha-nacimiento"></p>
                                    </div>
                                    <div class="mb-3">
                                        <h6 class="fw-bold text-muted">Edad:</h6>
                                        <p id="alumno-edad"></p>
                                    </div>
                                    <div class="mb-3">
                                        <h6 class="fw-bold text-muted">Sexo:</h6>
                                        <p id="alumno-sexo"></p>
                                    </div>
                                    <div class="mb-3">
                                        <h6 class="fw-bold text-muted">Estado Civil:</h6>
                                        <p id="alumno-estado-civil"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header" style="background-color: #5c6bc0; color: white;">
                                    <h6 class="mb-0"><i class="fas fa-school me-2"></i>Información Académica</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <h6 class="fw-bold text-muted">Nivel:</h6>
                                        <p id="alumno-nivel"></p>
                                    </div>
                                    <div class="mb-3">
                                        <h6 class="fw-bold text-muted">Jornada:</h6>
                                        <p id="alumno-jornada"></p>
                                    </div>
                                    <div class="mb-3">
                                        <h6 class="fw-bold text-muted">Fecha de Ingreso:</h6>
                                        <p id="alumno-fecha-ingreso"></p>
                                    </div>
                                    <div class="mb-3">
                                        <h6 class="fw-bold text-muted">Último Curso Aprobado:</h6>
                                        <p id="alumno-ultimo-curso"></p>
                                    </div>
                                    <div class="mb-3">
                                        <h6 class="fw-bold text-muted">Curso Repetido:</h6>
                                        <p id="alumno-curso-repetido"></p>
                                    </div>
                                    <div class="mb-3">
                                        <h6 class="fw-bold text-muted">Estado:</h6>
                                        <p id="alumno-estado"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header" style="background-color: #5c6bc0; color: white;">
                                    <h6 class="mb-0"><i class="fas fa-home me-2"></i>Información de Contacto</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <h6 class="fw-bold text-muted">Dirección:</h6>
                                        <p id="alumno-direccion"></p>
                                    </div>
                                    <div class="mb-3">
                                        <h6 class="fw-bold text-muted">Teléfono:</h6>
                                        <p id="alumno-telefono"></p>
                                    </div>
                                    <div class="mb-3">
                                        <h6 class="fw-bold text-muted">Correo Electrónico:</h6>
                                        <p id="alumno-email"></p>
                                    </div>
                                    <div class="mb-3">
                                        <h6 class="fw-bold text-muted">Religión:</h6>
                                        <p id="alumno-religion"></p>
                                    </div>
                                    <div class="mb-3">
                                        <h6 class="fw-bold text-muted">Situación Laboral:</h6>
                                        <p id="alumno-situacion-laboral"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header" style="background-color: #5c6bc0; color: white;">
                                    <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Información Adicional</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <h6 class="fw-bold text-muted">Programa PIE:</h6>
                                        <p id="alumno-programa-pie"></p>
                                    </div>
                                    <div class="mb-3">
                                        <h6 class="fw-bold text-muted">Profesional de Apoyo:</h6>
                                        <p id="alumno-profesional-apoyo"></p>
                                    </div>
                                    <div class="mb-3">
                                        <h6 class="fw-bold text-muted">Informe Psicosocial:</h6>
                                        <p id="alumno-informe-psicosocial"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="card h-100">
                                <div class="card-header" style="background-color: #5c6bc0; color: white;">
                                    <h6 class="mb-0"><i class="fas fa-phone-alt me-2"></i>Contacto de Emergencia</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <h6 class="fw-bold text-muted">Nombre:</h6>
                                        <p id="alumno-contacto-emergencia-nombre"></p>
                                    </div>
                                    <div class="mb-3">
                                        <h6 class="fw-bold text-muted">Parentezco:</h6>
                                        <p id="alumno-contacto-emergencia-parentezco"></p>
                                    </div>
                                    <div class="mb-3">
                                        <h6 class="fw-bold text-muted">Teléfono:</h6>
                                        <p id="alumno-contacto-emergencia-telefono"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="alumno-modal-error" class="alert alert-danger" style="display: none;">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <span id="alumno-error-message">Error al cargar los detalles del alumno.</span>
                </div>
            </div>
            <div class="modal-footer">
                <div class="d-flex justify-content-between w-100">
                    <div>
                        <button type="button" class="btn btn-danger" id="eliminar-alumno-btn">
                            <i class="fas fa-trash-alt me-1"></i> Eliminar Alumno
                        </button>
                    </div>
                    <div>
                        <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cerrar</button>
                        <a href="#" id="editar-alumno-link" class="btn" style="background-color: #26a69a; color: white;">
                            <i class="fas fa-edit me-1"></i> Editar Alumno
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmación para eliminar alumno -->
<div class="modal fade" id="confirmarEliminarAlumnoModal" tabindex="-1" aria-labelledby="confirmarEliminarAlumnoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="confirmarEliminarAlumnoModalLabel">Confirmar Eliminación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="background-color: white;"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <i class="fas fa-exclamation-triangle fa-4x text-warning mb-3"></i>
                    <h5>¿Estás seguro de que deseas eliminar este alumno?</h5>
                    <p class="text-danger">Esta acción no se puede deshacer y eliminará toda la información asociada al alumno.</p>
                </div>
                <div class="alert alert-warning">
                    <strong>Alumno a eliminar:</strong> <span id="alumno-a-eliminar"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form id="form-eliminar-alumno" method="post" action="">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash-alt me-1"></i> Eliminar Definitivamente
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
 <!-- Botón de ayuda flotante para la sección de cursos -->
 <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1050;">
    <button type="button" class="btn btn-primary rounded-circle shadow-lg d-flex align-items-center justify-content-center" style="width: 60px; height: 60px; background-color: #3f51b5; color: white;" data-bs-toggle="modal" data-bs-target="#cursosHelpModal">
        <i class="fas fa-question fa-2x"></i>
    </button>
</div>

<!-- Modal de Ayuda para Cursos -->
<div class="modal fade" id="cursosHelpModal" tabindex="-1" aria-labelledby="cursosHelpModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background-color: #3f51b5; color: white;">
                <h5 class="modal-title" id="cursosHelpModalLabel">Guía de Gestión de Cursos</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="accordion" id="cursosHelpAccordion">
                    <!-- Sección Resumen -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingResumen">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseResumen" aria-expanded="true" aria-controls="collapseResumen">
                                <i class="fas fa-school me-2"></i> Visión General
                            </button>
                        </h2>
                        <div id="collapseResumen" class="accordion-collapse collapse show" aria-labelledby="headingResumen" data-bs-parent="#cursosHelpAccordion">
                            <div class="accordion-body">
                                <p>La sección de Gestión de Cursos le permite administrar todos los cursos del establecimiento educativo.</p>
                                <p>Desde esta interfaz puede:</p>
                                <ul>
                                    <li><strong>Crear nuevos cursos</strong> con nivel y jornada específicos</li>
                                    <li><strong>Gestionar alumnos</strong> en los cursos correspondientes</li>
                                    <li><strong>Visualizar información detallada</strong> de cada curso</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-eliminar alertas después de 5 segundos
    const alerts = document.querySelectorAll('.alert');
    alerts.forEach(function(alert) {
        setTimeout(function() {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        }, 5000);
    });

    // Variables para los modales
    const detallesModal = document.getElementById('cursoDetallesModal');
    const confirmarEliminarModal = document.getElementById('confirmarEliminarModal');
    const alumnoDetallesModal = document.getElementById('alumnoDetallesModal');
    let cursoActualId = null;

    // Botones para ver detalles
    const verDetallesBtns = document.querySelectorAll('.ver-detalles-btn');
    verDetallesBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const cursoId = this.getAttribute('data-curso-id');
            cursoActualId = cursoId;
            cargarDetallesCurso(cursoId);
        });
    });

    // Función para cargar los detalles del curso
    function cargarDetallesCurso(cursoId) {
        // Mostrar loading y ocultar contenido y errores
        const loadingElement = document.getElementById('modal-loading');
        const contentElement = document.getElementById('modal-content');
        const errorElement = document.getElementById('modal-error');

        if (loadingElement) loadingElement.style.display = 'block';
        if (contentElement) contentElement.style.display = 'none';
        if (errorElement) errorElement.style.display = 'none';

        // Actualizar enlaces
        const editarLink = document.getElementById('editar-curso-link');
        if (editarLink) editarLink.href = `/cursos/editar/${cursoId}/`;

        // Intentar obtener datos del DOM primero (como respaldo)
        const cursoCard = document.querySelector(`.curso-card[data-curso-id="${cursoId}"]`);
        let cursoData = null;

        if (cursoCard) {
            // Extraer datos básicos del curso desde el DOM (si están disponibles)
            cursoData = {
                id: cursoId,
                nivel: cursoCard.querySelector('.nivel-curso')?.textContent,
                letra: cursoCard.querySelector('.letra-curso')?.textContent,
                jornada: cursoCard.querySelector('.jornada-curso')?.textContent,
            };
        }

        // Hacer la petición AJAX
        fetch(`/cursos/api/detalles/${cursoId}/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Error en la respuesta del servidor: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    mostrarDetallesCurso(data.data);
                } else {
                    if (cursoData) {
                        console.warn('Usando datos del DOM como respaldo');
                        mostrarDetallesCurso(cursoData);
                    } else {
                        mostrarError(data.error || 'Error al cargar los detalles del curso.');
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                if (cursoData) {
                    console.warn('Usando datos del DOM como respaldo después de error');
                    mostrarDetallesCurso(cursoData);
                } else {
                    mostrarError('Error de conexión al cargar los detalles. Detalles: ' + error.message);
                }
            })
            .finally(() => {
                if (loadingElement) loadingElement.style.display = 'none';
            });
    }

    // Función para mostrar los detalles del curso en el modal
    function mostrarDetallesCurso(curso) {
        function setTextSafely(id, text) {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = text || 'No disponible';
            }
        }
        function setHtmlSafely(id, html) {
            const element = document.getElementById(id);
            if (element) {
                element.innerHTML = html;
            }
        }
        try {
            setTextSafely('modal-nivel', `${curso.nivel}° Nivel`);
            setTextSafely('modal-jornada', curso.jornada);

            const jornadaBadge = document.getElementById('modal-jornada-badge');
            if (jornadaBadge) {
                jornadaBadge.textContent = curso.letra;
                jornadaBadge.className = `badge ${curso.letra === 'A' ? 'bg-warning' : 'bg-info'}`;
            }

            setTextSafely('modal-total-alumnos', `${curso.total_alumnos} alumnos`);

            // Información de los alumnos
            const alumnosLista = document.getElementById('modal-alumnos-lista');
            const alumnosContainer = document.getElementById('alumnos-table-container');
            const noAlumnosMessage = document.getElementById('no-alumnos-message');

            if (alumnosLista) {
                if (curso.alumnos && curso.alumnos.length > 0) {
                    if (alumnosContainer) alumnosContainer.style.display = 'block';
                    if (noAlumnosMessage) noAlumnosMessage.style.display = 'none';

                    alumnosLista.innerHTML = '';
                    curso.alumnos.forEach(alumno => {
                        alumnosLista.innerHTML += `
                            <tr>
                                <td>${alumno.nombre}</td>
                                <td></td>
                                <td>
                                    <button class="btn btn-sm ver-alumno-btn" 
                                       style="background-color: #5c6bc0; color: white;"
                                       title="Ver detalles del alumno"
                                       data-alumno-id="${alumno.id}">
                                        <i class="fas fa-eye"></i> Ver alumno
                                    </button>
                                </td>
                            </tr>
                        `;
                    });

                    setTimeout(() => {
                        document.querySelectorAll('.ver-alumno-btn').forEach(btn => {
                            btn.addEventListener('click', function() {
                                const alumnoId = this.getAttribute('data-alumno-id');
                                cargarDetallesAlumno(alumnoId);
                            });
                        });
                    }, 100);

                } else {
                    if (alumnosContainer) alumnosContainer.style.display = 'block';
                    if (noAlumnosMessage) noAlumnosMessage.style.display = 'none';
                    alumnosLista.innerHTML = '<tr><td colspan="3" class="text-center">No hay alumnos matriculados</td></tr>';
                }
            }

            const modalContent = document.getElementById('modal-content');
            if (modalContent) {
                modalContent.style.display = 'block';
            }

            setTextSafely('cursoDetallesModalLabel', `Detalles del Curso ${curso.nivel}° ${curso.letra}`);
            setTextSafely('curso-a-eliminar', `${curso.nivel}° ${curso.letra} (${curso.jornada})`);

            const formEliminarCurso = document.getElementById('form-eliminar-curso');
            if (formEliminarCurso) {
                formEliminarCurso.action = `/cursos/eliminar/${curso.id}/`;
            }
        } catch (error) {
            console.error('Error al mostrar detalles del curso:', error);
            mostrarError('Error al mostrar los detalles del curso: ' + error.message);
        }
    }

    // Función para cargar los detalles del alumno
    function cargarDetallesAlumno(alumnoId) {
        const cursoModalInstance = bootstrap.Modal.getInstance(detallesModal);
        cursoModalInstance.hide();

        const alumnoModalInstance = new bootstrap.Modal(alumnoDetallesModal);
        alumnoModalInstance.show();

        const loadingElement = document.getElementById('alumno-modal-loading');
        const contentElement = document.getElementById('alumno-modal-content');
        const errorElement = document.getElementById('alumno-modal-error');

        if (loadingElement) loadingElement.style.display = 'block';
        if (contentElement) contentElement.style.display = 'none';
        if (errorElement) errorElement.style.display = 'none';

        const editarLink = document.getElementById('editar-alumno-link');
        if (editarLink) editarLink.href = `/alumnos/${alumnoId}/editar/`;

        fetch(`/alumnos/api/detalles/${alumnoId}/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Error en la respuesta del servidor: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    console.log('Datos del alumno recibidos:', data.alumno);
                    // Usar data.alumno que contiene todos los detalles del alumno
                    mostrarDetallesAlumno(data.alumno);
                } else {
                    mostrarErrorAlumno(data.error || 'Error al cargar los detalles del alumno.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarErrorAlumno('Error de conexión al cargar los detalles del alumno. Detalles: ' + error.message);
            })
            .finally(() => {
                if (loadingElement) loadingElement.style.display = 'none';
            });
    }

    // Función para mostrar los detalles del alumno en el modal
    function mostrarDetallesAlumno(alumno) {
        function setTextSafely(id, text) {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = text || 'No disponible';
            }
        }
        function setHtmlSafely(id, html) {
            const element = document.getElementById(id);
            if (element) {
                element.innerHTML = html;
            }
        }
        try {
            // Información personal
            setTextSafely('alumno-nombre', alumno.nombre_completo);
            setTextSafely('alumno-rut', alumno.rut);
            setTextSafely('alumno-fecha-nacimiento', alumno.fecha_nacimiento);
            setTextSafely('alumno-edad', alumno.edad ? `${alumno.edad} años` : null);
            setTextSafely('alumno-sexo', alumno.sexo);
            setTextSafely('alumno-estado-civil', alumno.estado_civil);
            
            // Información académica
            setTextSafely('alumno-nivel', alumno.nivel);
            setTextSafely('alumno-jornada', alumno.jornada);
            setTextSafely('alumno-fecha-ingreso', alumno.fecha_ingreso);
            setTextSafely('alumno-ultimo-curso', alumno.ultimo_curso_aprobado);
            setTextSafely('alumno-curso-repetido', alumno.curso_repetido);
            
            // Estado del alumno
            const estadoHtml = alumno.activo ? 
                '<span style="color: #28a745; font-weight: bold;"><i class="fas fa-check-circle me-1"></i> Activo</span>' : 
                '<span style="color: #dc3545; font-weight: bold;"><i class="fas fa-times-circle me-1"></i> Inactivo</span>';
            setHtmlSafely('alumno-estado', estadoHtml);
            
            // Información de contacto
            setTextSafely('alumno-direccion', alumno.direccion);
            setTextSafely('alumno-telefono', alumno.telefono);
            setTextSafely('alumno-email', alumno.correo_electronico);
            setTextSafely('alumno-religion', alumno.religion);
            setTextSafely('alumno-situacion-laboral', alumno.situacion_laboral);
            
            // Información PIE
            setTextSafely('alumno-programa-pie', alumno.programa_pie);
            setTextSafely('alumno-profesional-apoyo', alumno.profesional_apoyo);
            setTextSafely('alumno-informe-psicosocial', alumno.informe_psicosocial);
            
            // Contacto de emergencia
            if (alumno.contacto_emergencia) {
                setTextSafely('alumno-contacto-emergencia-nombre', alumno.contacto_emergencia.nombre);
                setTextSafely('alumno-contacto-emergencia-parentezco', alumno.contacto_emergencia.parentezco);
                setTextSafely('alumno-contacto-emergencia-telefono', alumno.contacto_emergencia.telefono);
            } else {
                // Intentar acceder directamente a las propiedades si no está en un objeto anidado
                setTextSafely('alumno-contacto-emergencia-nombre', alumno.contacto_emergencia_nombre);
                setTextSafely('alumno-contacto-emergencia-parentezco', alumno.contacto_emergencia_parentezco);
                setTextSafely('alumno-contacto-emergencia-telefono', alumno.contacto_emergencia_telefono);
            }
            
            // Mostrar el contenido
            const modalContent = document.getElementById('alumno-modal-content');
            if (modalContent) {
                modalContent.style.display = 'block';
            }
            
            // Actualizar el título del modal
            setTextSafely('alumnoDetallesModalLabel', `Detalles del Alumno: ${alumno.nombre_completo}`);
            
            // Configurar botones de acción
            const eliminarBtn = document.getElementById('eliminar-alumno-btn');
            if (eliminarBtn) {
                eliminarBtn.onclick = () => {
                    const detallesModal = document.getElementById('alumnoDetallesModal');
                    if (detallesModal) {
                        const detallesModalInstance = bootstrap.Modal.getInstance(detallesModal);
                        if (detallesModalInstance) {
                            detallesModalInstance.hide();
                        }
                    }
                    setTextSafely('alumno-a-eliminar', alumno.nombre_completo);
                    const formEliminar = document.getElementById('form-eliminar-alumno');
                    if (formEliminar) {
                        formEliminar.action = `/alumnos/${alumno.id}/eliminar/`;
                    }
                    const confirmarEliminarModal = document.getElementById('confirmarEliminarAlumnoModal');
                    if (confirmarEliminarModal) {
                        const confirmarEliminarModalInstance = new bootstrap.Modal(confirmarEliminarModal);
                        confirmarEliminarModalInstance.show();
                    }
                };
            }
            
            // Configurar enlace de edición
            const editarLink = document.getElementById('editar-alumno-link');
            if (editarLink) {
                editarLink.href = `/alumnos/${alumno.id}/editar/`;
            }
            
        } catch (error) {
            console.error('Error al mostrar detalles del alumno:', error);
            mostrarErrorAlumno('Error al mostrar los detalles del alumno: ' + error.message);
        }
    }

    function mostrarErrorAlumno(mensaje) {
        const errorElement = document.getElementById('alumno-modal-error');
        const mensajeElement = document.getElementById('alumno-error-message');
        if (errorElement && mensajeElement) {
            mensajeElement.textContent = mensaje;
            errorElement.style.display = 'block';
        }
    }

    function mostrarError(mensaje) {
        const errorElement = document.getElementById('modal-error');
        const mensajeElement = document.getElementById('error-message');
        if (errorElement && mensajeElement) {
            mensajeElement.textContent = mensaje;
            errorElement.style.display = 'block';
        }
    }

    const eliminarCursoBtn = document.getElementById('eliminar-curso-btn');
    if (eliminarCursoBtn) {
        eliminarCursoBtn.addEventListener('click', function() {
            const detallesModalInstance = bootstrap.Modal.getInstance(detallesModal);
            if (detallesModalInstance) {
                detallesModalInstance.hide();
            }
            const confirmarEliminarModalInstance = new bootstrap.Modal(confirmarEliminarModal);
            confirmarEliminarModalInstance.show();
        });
    }

    const cursoCards = document.querySelectorAll('.curso-card');
    cursoCards.forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-5px)';
            this.style.transition = 'transform 0.3s ease';
            this.style.boxShadow = '0 10px 20px rgba(0,0,0,0.1)';
        });
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = '';
        });
    });

    if (alumnoDetallesModal) {
        alumnoDetallesModal.addEventListener('hidden.bs.modal', function () {
            if (cursoActualId) {
                const cursoModalInstance = new bootstrap.Modal(detallesModal);
                cursoModalInstance.show();
            }
        });
    }
});
</script>
{% endblock %}
